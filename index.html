<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Manajemen Ketahfizan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script><!-- Firebase SDK -->
  <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
  apiKey: "AIzaSyAxoe-Bg6WUn59KjzaunvkCRVUbi1X95PQ",
  authDomain: "tahfidzmabash.firebaseapp.com",
  projectId: "tahfidzmabash",
  storageBucket: "tahfidzmabash.firebasestorage.app",
  messagingSenderId: "113529956394",
  appId: "1:113529956394:web:d6c9eedda4014fae937b53",
  measurementId: "G-GN5B5DLSPH"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc };
    </script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nav-item {
            transition: all 0.2s ease;
        }
        
        .nav-item:hover {
            background-color: rgba(79, 70, 229, 0.1);
        }
        
        .nav-item.active {
            background-color: #4f46e5;
            color: white;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="flex h-full w-full bg-gray-50"><!-- Sidebar -->
   <aside class="w-16 bg-white shadow-lg border-r border-gray-200 flex flex-col h-full">
    <div class="p-2 border-b border-gray-200">
     <div class="flex items-center justify-center"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSquCqPBndiUDFRhkSqzMeghINKap_pRxFY5A&amp;s" alt="Logo" class="w-10 h-10 rounded-lg object-contain">
     </div>
    </div>
    <nav class="flex-1 p-2 space-y-1 overflow-y-auto"><button onclick="switchPanel('dashboard')" class="nav-item active w-full flex items-center justify-center p-3 rounded-lg" title="Dashboard"> <i class="fas fa-th-large text-lg"></i> </button> <button onclick="switchPanel('santri')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Kelola Santri"> <i class="fas fa-users text-lg"></i> </button> <button onclick="switchPanel('tahfidz')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Input Tahfidz"> <i class="fas fa-book text-lg"></i> </button> <button onclick="switchPanel('tahsin')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Input Tahsin"> <i class="fas fa-check-circle text-lg"></i> </button> <button onclick="switchPanel('murajaah')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Input Murajaah"> <i class="fas fa-sync-alt text-lg"></i> </button> <button onclick="switchPanel('hadits')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Input Hadits"> <i class="fas fa-scroll text-lg"></i> </button> <button onclick="switchPanel('mutabaah')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Mutabaah Yaumiyah"> <i class="fas fa-tasks text-lg"></i> </button> <button onclick="switchPanel('sesi')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Kelola Sesi"> <i class="fas fa-clock text-lg"></i> </button> <button onclick="switchPanel('absensi')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Input Absensi"> <i class="fas fa-clipboard-check text-lg"></i> </button> <button onclick="switchPanel('laporan')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Laporan Mingguan"> <i class="fas fa-chart-line text-lg"></i> </button> <button onclick="switchPanel('bulanan')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Laporan Bulanan"> <i class="fas fa-calendar-alt text-lg"></i> </button> <button onclick="switchPanel('rapor')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Rapor Semester"> <i class="fas fa-file-invoice text-lg"></i> </button>
    </nav>
    <button onclick="switchPanel('pembimbing')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Kelola Pembimbing"> 
    <i class="fas fa-user-tie text-lg"></i> 
</button>
   </aside><!-- Main Content -->
   <main class="flex-1 overflow-auto"><!-- Dashboard Content -->
    <div id="content-dashboard" class="content-panel p-6">
     <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-500">Total Santri</p>
         <p id="stat-santri" class="text-3xl font-bold text-gray-800 mt-2">0</p>
        </div>
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"><i class="fas fa-users text-blue-600 text-xl"></i>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-500">Input Tahfidz</p>
         <p id="stat-tahfidz" class="text-3xl font-bold text-gray-800 mt-2">0</p>
        </div>
        <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center"><i class="fas fa-book text-indigo-600 text-xl"></i>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-500">Input Tahsin</p>
         <p id="stat-tahsin" class="text-3xl font-bold text-gray-800 mt-2">0</p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"><i class="fas fa-check-circle text-green-600 text-xl"></i>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-500">Input Murajaah</p>
         <p id="stat-murajaah" class="text-3xl font-bold text-gray-800 mt-2">0</p>
        </div>
        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center"><i class="fas fa-sync-alt text-purple-600 text-xl"></i>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-500">Input Hadits</p>
         <p id="stat-hadits" class="text-3xl font-bold text-gray-800 mt-2">0</p>
        </div>
        <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center"><i class="fas fa-scroll text-amber-600 text-xl"></i>
        </div>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i class="fas fa-bolt text-yellow-500 mr-2"></i> Quick Actions</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4"><button onclick="switchPanel('tahfidz')" class="flex items-center space-x-3 p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition duration-200"> <i class="fas fa-plus-circle text-indigo-600 text-2xl"></i>
        <div class="text-left">
         <p class="font-semibold text-gray-800">Input Data Baru</p>
         <p class="text-xs text-gray-500">Tambah data harian santri</p>
        </div></button> <button onclick="switchPanel('laporan')" class="flex items-center space-x-3 p-4 bg-green-50 hover:bg-green-100 rounded-lg transition duration-200"> <i class="fas fa-file-alt text-green-600 text-2xl"></i>
        <div class="text-left">
         <p class="font-semibold text-gray-800">Lihat Laporan</p>
         <p class="text-xs text-gray-500">Generate laporan mingguan</p>
        </div></button> <button onclick="switchPanel('bulanan')" class="flex items-center space-x-3 p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition duration-200"> <i class="fas fa-chart-bar text-purple-600 text-2xl"></i>
        <div class="text-left">
         <p class="font-semibold text-gray-800">Laporan Bulanan</p>
         <p class="text-xs text-gray-500">Ringkasan bulanan</p>
        </div></button>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Kelola Santri Content -->
    <div id="content-santri" class="content-panel hidden p-6">
     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-user-plus text-blue-600 mr-2"></i> Tambah Santri</h3>
       <form id="form-add-santri" class="space-y-4">
        <div><label for="santri-nis" class="block text-sm font-medium text-gray-700 mb-2">NIS</label> <input type="text" id="santri-nis" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div><label for="santri-nama" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="santri-nama" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div><label for="santri-kelas" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <input type="text" id="santri-kelas" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
    <label for="santri-wali" class="block text-sm font-medium text-gray-700 mb-2">Nama Orang Tua / Wali</label>
    <input type="text" id="santri-wali" required placeholder="Nama Ayah/Ibu/Wali" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
</div>
        <div>
    <label for="santri-pembimbing" class="block text-sm font-medium text-gray-700 mb-2">Nama Pembimbing</label>
    <input type="text" id="santri-pembimbing" required placeholder="Contoh: Ust. Ahmad" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
</div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="santri-hafalan-juz" class="block text-sm font-medium text-gray-700 mb-2">Total Hafalan Juz</label> <input type="number" id="santri-hafalan-juz" min="0" max="30" placeholder="0-30" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
         </div>
         <div><label for="santri-hafalan-halaman" class="block text-sm font-medium text-gray-700 mb-2">Total Hafalan Halaman</label> <input type="number" id="santri-hafalan-halaman" min="0" max="604" placeholder="0-604" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
         </div>
        </div>
        <div><label for="santri-hafalan-hadits" class="block text-sm font-medium text-gray-700 mb-2">Total Hafalan Hadits</label> <input type="number" id="santri-hafalan-hadits" min="0" placeholder="0" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div><button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="add-santri-btn-text">Tambah Santri</span>
         <div id="add-santri-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
      <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-users text-indigo-600 mr-2"></i> Daftar Santri</h3>
       <div id="santri-list-container" class="space-y-3">
        <div class="text-center py-12"><i class="fas fa-user-friends text-gray-300 text-5xl mb-4"></i>
         <p class="text-gray-500">Belum ada santri. Tambahkan santri baru!</p>
        </div>
       </div>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Input Tahfidz Content -->
    <div id="content-tahfidz" class="content-panel hidden p-6">
     <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-book text-indigo-600 mr-3 text-2xl"></i> Input Tahfidz</h3>
       <form id="form-tahfidz" class="space-y-4">
        <div><label for="tahfidz-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="tahfidz-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="tahfidz-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="tahfidz-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="tahfidz-juz" class="block text-sm font-medium text-gray-700 mb-2">Juz</label> <input type="number" id="tahfidz-juz" min="1" max="30" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
         </div>
         <div><label for="tahfidz-halaman" class="block text-sm font-medium text-gray-700 mb-2">Halaman</label> <input type="number" id="tahfidz-halaman" min="1" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
         </div>
        </div>
        <div><label for="tahfidz-nilai" class="block text-sm font-medium text-gray-700 mb-2">Nilai</label> <select id="tahfidz-nilai" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"> <option value="">Pilih Nilai</option> <option value="A">A - Sangat Baik</option> <option value="B">B - Baik</option> <option value="C">C - Cukup</option> <option value="D">D - Kurang</option> </select>
        </div><button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="tahfidz-btn-text">Simpan Tahfidz</span>
         <div id="tahfidz-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Input Tahsin Content -->
    <div id="content-tahsin" class="content-panel hidden p-6">
     <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-check-circle text-green-600 mr-3 text-2xl"></i> Input Tahsin</h3>
       <form id="form-tahsin" class="space-y-4">
        <div><label for="tahsin-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="tahsin-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="tahsin-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="tahsin-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div><label for="tahsin-kategori" class="block text-sm font-medium text-gray-700 mb-2">Kategori</label> <select id="tahsin-kategori" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">Pilih Kategori</option> <option value="Makhorijul Huruf">Makhorijul Huruf</option> <option value="Tajwid">Tajwid</option> </select>
        </div>
        <div><label for="tahsin-nilai" class="block text-sm font-medium text-gray-700 mb-2">Nilai</label> <select id="tahsin-nilai" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">Pilih Nilai</option> <option value="A">A - Sangat Baik</option> <option value="B">B - Baik</option> <option value="C">C - Cukup</option> <option value="D">D - Kurang</option> </select>
        </div><button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="tahsin-btn-text">Simpan Tahsin</span>
         <div id="tahsin-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Input Murajaah Content -->
    <div id="content-murajaah" class="content-panel hidden p-6">
     <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-sync-alt text-purple-600 mr-3 text-2xl"></i> Input Murajaah</h3>
       <form id="form-murajaah" class="space-y-4">
        <div><label for="murajaah-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="murajaah-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="murajaah-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="murajaah-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="murajaah-juz" class="block text-sm font-medium text-gray-700 mb-2">Juz</label> <input type="number" id="murajaah-juz" min="1" max="30" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
         </div>
         <div><label for="murajaah-halaman" class="block text-sm font-medium text-gray-700 mb-2">Halaman</label> <input type="number" id="murajaah-halaman" min="1" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
         </div>
        </div>
        <div><label for="murajaah-nilai" class="block text-sm font-medium text-gray-700 mb-2">Nilai</label> <select id="murajaah-nilai" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"> <option value="">Pilih Nilai</option> <option value="A">A - Sangat Baik</option> <option value="B">B - Baik</option> <option value="C">C - Cukup</option> <option value="D">D - Kurang</option> </select>
        </div><button type="submit" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="murajaah-btn-text">Simpan Murajaah</span>
         <div id="murajaah-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Input Hadits Content -->
    <div id="content-hadits" class="content-panel hidden p-6">
     <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-scroll text-amber-600 mr-3 text-2xl"></i> Input Hadits</h3>
       <form id="form-hadits" class="space-y-4">
        <div><label for="hadits-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="hadits-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="hadits-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="hadits-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
        </div>
        <div><label for="hadits-judul" class="block text-sm font-medium text-gray-700 mb-2">Hadits ke-</label> <input type="number" id="hadits-judul" placeholder="Contoh: 1, 2, 3..." min="1" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
        </div>
        <div><label for="hadits-nilai" class="block text-sm font-medium text-gray-700 mb-2">Nilai</label> <select id="hadits-nilai" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"> <option value="">Pilih Nilai</option> <option value="A">A - Sangat Baik</option> <option value="B">B - Baik</option> <option value="C">C - Cukup</option> <option value="D">D - Kurang</option> </select>
        </div><button type="submit" class="w-full bg-amber-600 text-white py-3 px-4 rounded-lg hover:bg-amber-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="hadits-btn-text">Simpan Hadits</span>
         <div id="hadits-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Mutabaah Yaumiyah Content -->
    <div id="content-mutabaah" class="content-panel hidden p-6">
     <div class="max-w-3xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-tasks text-teal-600 mr-3 text-2xl"></i> Mutabaah Yaumiyah</h3>
       <form id="form-mutabaah" class="space-y-6">
        <div><label for="mutabaah-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="mutabaah-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="mutabaah-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="mutabaah-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
        </div>
        <div><label for="mutabaah-nilai" class="block text-sm font-medium text-gray-700 mb-2">Nilai (Otomatis berdasarkan kelengkapan)</label> <select id="mutabaah-nilai" required disabled class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"> <option value="">Centang aktivitas untuk mendapat nilai</option> <option value="A">A - Sangat Baik (11 aktivitas)</option> <option value="B">B - Baik (8-10 aktivitas)</option> <option value="C">C - Cukup (5-7 aktivitas)</option> <option value="D">D - Kurang (1-4 aktivitas)</option> </select>
        </div><!-- Aktivitas Harian -->
        <div>
         <h4 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-clipboard-list text-teal-600 mr-2"></i> Aktivitas Harian</h4>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-3"><label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Subuh" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Subuh</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Zhuhur" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Zhuhur</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Ashar" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Ashar</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Maghrib" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Maghrib</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Isya'" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Isya'</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Rawatib" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Rawatib</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Dhuha" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Dhuha</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Dzikir Pagi-Petang" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Dzikir Pagi-Petang</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Lail" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Lail</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Puasa Sunnah" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Puasa Sunnah</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Hafal Hadits" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Hafal Hadits</span> </label>
         </div>
        </div><button type="submit" class="w-full bg-teal-600 text-white py-3 px-4 rounded-lg hover:bg-teal-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="mutabaah-btn-text">Simpan Mutabaah</span>
         <div id="mutabaah-yaumiyah-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Kelola Sesi Content -->
    <div id="content-sesi" class="content-panel hidden p-6">
     <div class="max-w-4xl mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Form Kelola Sesi -->
       <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-clock text-blue-600 mr-2"></i> Tambah Sesi Baru</h3>
        <form id="form-sesi" class="space-y-4">
         <div><label for="sesi-nama" class="block text-sm font-medium text-gray-700 mb-2">Nama Sesi</label> <input type="text" id="sesi-nama" placeholder="Contoh: Subuh, Dzuhur" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
         </div>
         <div class="grid grid-cols-2 gap-4">
          <div><label for="sesi-jam-mulai" class="block text-sm font-medium text-gray-700 mb-2">Jam Mulai</label> <input type="time" id="sesi-jam-mulai" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div><label for="sesi-jam-berakhir" class="block text-sm font-medium text-gray-700 mb-2">Jam Berakhir</label> <input type="time" id="sesi-jam-berakhir" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
         </div><button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-semibold flex items-center justify-center"> <i class="fas fa-plus mr-2"></i> <span id="sesi-btn-text">Tambah Sesi</span>
          <div id="sesi-spinner" class="loading-spinner ml-2 hidden"></div></button>
        </form>
       </div><!-- Daftar Sesi -->
       <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-list text-indigo-600 mr-2"></i> Daftar Sesi</h3>
        <div id="sesi-list" class="space-y-2">
         <p class="text-sm text-gray-500 text-center py-8">Belum ada sesi</p>
        </div>
       </div>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Input Absensi Content -->
    <div id="content-absensi" class="content-panel hidden p-6">
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Form Input Absensi -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-clipboard-check text-green-600 mr-2"></i> Input Absensi</h3>
       <form id="form-absensi" class="space-y-4">
        <div><label for="absensi-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="absensi-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="absensi-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="absensi-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div><label for="absensi-sesi" class="block text-sm font-medium text-gray-700 mb-2">Sesi</label> <select id="absensi-sesi" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">-- Pilih Sesi --</option> </select>
        </div>
        <div><label for="absensi-status" class="block text-sm font-medium text-gray-700 mb-2">Status</label> <select id="absensi-status" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">Pilih Status</option> <option value="Hadir">✓ Hadir</option> <option value="Izin">⊗ Izin</option> <option value="Sakit">+ Sakit</option> <option value="Alpa">✗ Alpa</option> </select>
        </div><button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="absensi-btn-text">Simpan Absensi</span>
         <div id="absensi-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div><!-- Riwayat Absensi -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-history text-purple-600 mr-2"></i> Riwayat Absensi</h3>
       <div id="absensi-history-container" class="space-y-3 max-h-[600px] overflow-y-auto">
        <div class="text-center py-8"><i class="fas fa-clipboard-list text-gray-300 text-4xl mb-3"></i>
         <p class="text-gray-500 text-sm">Belum ada data absensi</p>
        </div>
       </div>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Laporan Mingguan Content -->
    <div id="content-laporan" class="content-panel hidden p-6">
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-chart-line text-indigo-600 mr-3"></i> Laporan Mingguan - Pilih Santri</h3>
      <div id="weekly-santri-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
       <div class="text-center py-12 col-span-full"><i class="fas fa-users text-gray-300 text-5xl mb-4"></i>
        <p class="text-gray-500">Belum ada santri</p>
       </div>
      </div>
     </div><!-- Detail Laporan (Hidden by default) -->
     <div id="weekly-report-detail" class="hidden mt-6 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex justify-between items-center mb-6 no-print"><button id="btn-back-weekly" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"> <i class="fas fa-arrow-left mr-2"></i> Kembali ke Daftar </button> <button id="btn-download-weekly" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center"> <i class="fas fa-download mr-2"></i> Download PDF </button>
      </div>
      <div id="weekly-report-container"></div>
     </div>
    </div><!-- Laporan Bulanan Content -->
    <div id="content-bulanan" class="content-panel hidden p-6">
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-calendar-alt text-indigo-600 mr-3"></i> Laporan Bulanan - Pilih Santri</h3>
      <div id="monthly-santri-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
       <div class="text-center py-12 col-span-full"><i class="fas fa-users text-gray-300 text-5xl mb-4"></i>
        <p class="text-gray-500">Belum ada santri</p>
       </div>
      </div>
     </div><!-- Detail Laporan (Hidden by default) -->
     <div id="monthly-report-detail" class="hidden mt-6 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex justify-between items-center mb-6 no-print"><button id="btn-back-monthly" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"> <i class="fas fa-arrow-left mr-2"></i> Kembali ke Daftar </button> <button id="btn-download-monthly" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center"> <i class="fas fa-download mr-2"></i> Download PDF </button>
      </div>
      <div id="monthly-report-container"></div>
     </div>
    </div><!-- Rapor Semester Content -->
    <div id="content-rapor" class="content-panel hidden p-6">
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-file-invoice text-indigo-600 mr-3"></i> Rapor Semester - Pilih Santri</h3>
      <div id="rapor-santri-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
       <div class="text-center py-12 col-span-full"><i class="fas fa-users text-gray-300 text-5xl mb-4"></i>
        <p class="text-gray-500">Belum ada santri</p>
       </div>
      </div>
     </div><!-- Detail Rapor (Hidden by default) -->
     <div id="rapor-report-detail" class="hidden mt-6 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex justify-between items-center mb-6 no-print"><button id="btn-back-rapor" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"> <i class="fas fa-arrow-left mr-2"></i> Kembali ke Daftar </button> <button id="btn-download-rapor" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center"> <i class="fas fa-download mr-2"></i> Download PDF </button>
      </div>
      <div id="rapor-report-container"></div>
     </div>
    </div>
    <div id="content-pembimbing" class="content-panel hidden p-6">
    <div class="max-w-4xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-user-plus text-indigo-600 mr-2"></i> <span id="pembimbing-form-title">Tambah Pembimbing</span></h3>
                <form id="form-pembimbing" class="space-y-4">
                    <input type="hidden" id="pembimbing-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                        <input type="text" id="pembimbing-nama" required placeholder="Contoh: Ust. Ahmad, S.Pd" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Spesialisasi / Jabatan</label>
                        <input type="text" id="pembimbing-jabatan" placeholder="Contoh: Pengajar Tahfidz" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 font-semibold flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i> <span id="pembimbing-btn-text">Simpan Pembimbing</span>
                        <div id="pembimbing-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                    <button type="button" id="btn-cancel-pembimbing" class="w-full mt-2 text-gray-500 text-sm hidden">Batal Edit</button>
                </form>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-address-book text-blue-600 mr-2"></i> Daftar Pembimbing</h3>
                <div id="pembimbing-list" class="space-y-2">
                    <p class="text-sm text-gray-500 text-center py-8">Memuat data...</p>
                </div>
            </div>
        </div>
    </div>
</div>
   </main>
  </div>
  <script type="module">
        // Local cache untuk data
        const localCache = {
            santri: [],
            tahfidz: [],
            tahsin: [],
            murajaah: [],
            hadits: [],
            mutabaah: [],
            sesi: [],
            absensi: []
            pembimbing: [] //
        };

        // Inisialisasi Firebase listeners
        async function initFirebaseListeners() {
            const { onSnapshot, collection, query, orderBy } = window.firestore;
            const db = window.db;

            // Listen to santri collection
            onSnapshot(query(collection(db, 'santri'), orderBy('nama', 'asc')), (snapshot) => {
                localCache.santri = [];
                snapshot.forEach((doc) => {
                    localCache.santri.push({ id: doc.id, ...doc.data() });
                });
                refreshSantriList();
                updateStats();
                populateSantriSelects();
            });

            // Listen to tahfidz collection
            onSnapshot(collection(db, 'tahfidz'), (snapshot) => {
                localCache.tahfidz = [];
                snapshot.forEach((doc) => {
                    localCache.tahfidz.push({ id: doc.id, ...doc.data() });
                });
                updateStats();
            });

            // Listen to tahsin collection
            onSnapshot(collection(db, 'tahsin'), (snapshot) => {
                localCache.tahsin = [];
                snapshot.forEach((doc) => {
                    localCache.tahsin.push({ id: doc.id, ...doc.data() });
                });
                updateStats();
            });

            // Listen to murajaah collection
            onSnapshot(collection(db, 'murajaah'), (snapshot) => {
                localCache.murajaah = [];
                snapshot.forEach((doc) => {
                    localCache.murajaah.push({ id: doc.id, ...doc.data() });
                });
                updateStats();
            });

            // Listen to hadits collection
            onSnapshot(collection(db, 'hadits'), (snapshot) => {
                localCache.hadits = [];
                snapshot.forEach((doc) => {
                    localCache.hadits.push({ id: doc.id, ...doc.data() });
                });
                updateStats();
            });

            // Listen to mutabaah collection
            onSnapshot(collection(db, 'mutabaah'), (snapshot) => {
                localCache.mutabaah = [];
                snapshot.forEach((doc) => {
                    localCache.mutabaah.push({ id: doc.id, ...doc.data() });
                });
            });

            // Listen to sesi collection
            onSnapshot(collection(db, 'sesi'), (snapshot) => {
                localCache.sesi = [];
                snapshot.forEach((doc) => {
                    localCache.sesi.push({ id: doc.id, ...doc.data() });
                });
                refreshSesiList();
                populateSesiSelect();
            });

            // Listen to absensi collection
            onSnapshot(collection(db, 'absensi'), (snapshot) => {
                localCache.absensi = [];
                snapshot.forEach((doc) => {
                    localCache.absensi.push({ id: doc.id, ...doc.data() });
                });
                refreshAbsensiHistory();
            });
         // Tambahkan di dalam fungsi initFirebaseListeners()
         onSnapshot(query(collection(db, 'pembimbing'), orderBy('nama', 'asc')), (snapshot) => {
    localCache.pembimbing = [];
    snapshot.forEach((doc) => {
        localCache.pembimbing.push({ id: doc.id, ...doc.data() });
    });
    refreshPembimbingList();
});
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function setLoading(btnTextId, spinnerId, isLoading) {
            const spinner = document.getElementById(spinnerId);
            const btnText = document.getElementById(btnTextId);
            const button = btnText ? btnText.closest('button') : null;
            
            if (spinner) {
                if (isLoading) {
                    spinner.classList.remove('hidden');
                    if (button) button.disabled = true;
                } else {
                    spinner.classList.add('hidden');
                    if (button) button.disabled = false;
                }
            }
        }

        // Navigation
        window.switchPanel = function(panelName) {
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                item.classList.add('text-gray-600');
            });
            
            const panel = document.getElementById(`content-${panelName}`);
            if (panel) panel.classList.remove('hidden');
            
            const navButtons = document.querySelectorAll('.nav-item');
            navButtons.forEach((btn, index) => {
                const panels = ['dashboard', 'santri', 'tahfidz', 'tahsin', 'murajaah', 'hadits', 'mutabaah', 'sesi', 'absensi', 'laporan', 'bulanan', 'rapor', 'pembimbing'];
                if (panels[index] === panelName) {
                    btn.classList.add('active');
                    btn.classList.remove('text-gray-600');
                }
            });
        };

        function updateStats() {
            document.getElementById('stat-santri').textContent = localCache.santri.length;
            document.getElementById('stat-tahfidz').textContent = localCache.tahfidz.length;
            document.getElementById('stat-tahsin').textContent = localCache.tahsin.length;
            document.getElementById('stat-murajaah').textContent = localCache.murajaah.length;
            document.getElementById('stat-hadits').textContent = localCache.hadits.length;
        }

        function refreshSesiList() {
            const container = document.getElementById('sesi-list');
            
            if (localCache.sesi.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Belum ada sesi</p>';
                return;
            }
            
            let html = '';
            localCache.sesi.forEach(sesi => {
                html += `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg bg-blue-50">
                        <div>
                            <p class="font-semibold text-gray-800">${sesi.nama}</p>
                            <p class="text-sm text-gray-600">${sesi.jam_mulai} - ${sesi.jam_berakhir}</p>
                        </div>
                        <button onclick="deleteSesi('${sesi.id}', '${sesi.nama}')" class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function populateSesiSelect() {
            const select = document.getElementById('absensi-sesi');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Pilih Sesi --</option>';
            localCache.sesi.forEach(sesi => {
                const option = document.createElement('option');
                option.value = sesi.id;
                option.textContent = `${sesi.nama} (${sesi.jam_mulai} - ${sesi.jam_berakhir})`;
                option.dataset.nama = sesi.nama;
                option.dataset.jamMulai = sesi.jam_mulai;
                option.dataset.jamBerakhir = sesi.jam_berakhir;
                select.appendChild(option);
            });
        }
        
        function refreshAbsensiHistory() {
            const container = document.getElementById('absensi-history-container');
            
            if (localCache.absensi.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-clipboard-list text-gray-300 text-4xl mb-3"></i>
                        <p class="text-gray-500 text-sm">Belum ada data absensi</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            const statusColors = {
                'Hadir': 'bg-green-100 text-green-800',
                'Izin': 'bg-yellow-100 text-yellow-800',
                'Sakit': 'bg-blue-100 text-blue-800',
                'Alpa': 'bg-red-100 text-red-800'
            };
            
            const statusIcons = {
                'Hadir': '✓',
                'Izin': '⊗',
                'Sakit': '+',
                'Alpa': '✗'
            };
            
            localCache.absensi.slice().reverse().forEach(item => {
                html += `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h5 class="font-semibold text-gray-800">${item.santri_nama}</h5>
                                <p class="text-sm text-gray-500">${new Date(item.tanggal).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            </div>
                            <div class="px-3 py-1 rounded-full text-sm font-bold ${statusColors[item.status] || 'bg-gray-100 text-gray-800'}">
                                ${statusIcons[item.status]} ${item.status}
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-gray-600 mt-2">
                            <i class="fas fa-clock mr-2"></i>
                            <span class="font-medium">${item.sesi_nama}</span>
                            <span class="mx-2">•</span>
                            <span>${item.sesi_jam_mulai} - ${item.sesi_jam_berakhir}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        window.deleteSesi = async function(sesiId, sesiNama) {
            const deleteBtn = event.target.closest('button');
            const originalHtml = deleteBtn.innerHTML;
            
            if (!deleteBtn.classList.contains('confirm-delete')) {
                deleteBtn.classList.add('confirm-delete', 'bg-red-700');
                deleteBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                
                setTimeout(() => {
                    deleteBtn.classList.remove('confirm-delete', 'bg-red-700');
                    deleteBtn.innerHTML = originalHtml;
                }, 3000);
                return;
            }
            
            try {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                const { deleteDoc, doc } = window.firestore;
                const db = window.db;
                
                await deleteDoc(doc(db, 'sesi', sesiId));
                showToast(`Sesi ${sesiNama} berhasil dihapus!`, 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menghapus sesi: ' + error.message, 'error');
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHtml;
            }
        };

        function populateSantriSelects() {
            const selects = [
                document.getElementById('tahfidz-santri-select'),
                document.getElementById('tahsin-santri-select'),
                document.getElementById('murajaah-santri-select'),
                document.getElementById('hadits-santri-select'),
                document.getElementById('mutabaah-santri-select'),
                document.getElementById('absensi-santri-select')
            ];

            selects.forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="">-- Pilih Santri --</option>';
                
                localCache.santri.forEach(santri => {
                    const option = document.createElement('option');
                    option.value = santri.id;
                    option.textContent = `${santri.nama} (${santri.nis})`;
                    option.dataset.nis = santri.nis;
                    option.dataset.nama = santri.nama;
                    select.appendChild(option);
                });
            });
            
            // Populate report santri lists
            populateReportSantriLists();
        }
        
        function populateReportSantriLists() {
            const weeklyList = document.getElementById('weekly-santri-list');
            const monthlyList = document.getElementById('monthly-santri-list');
            const raporList = document.getElementById('rapor-santri-list');
            
            if (localCache.santri.length === 0) {
                const emptyHtml = `
                    <div class="text-center py-12 col-span-full">
                        <i class="fas fa-users text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-500">Belum ada santri</p>
                    </div>
                `;
                if (weeklyList) weeklyList.innerHTML = emptyHtml;
                if (monthlyList) monthlyList.innerHTML = emptyHtml;
                if (raporList) raporList.innerHTML = emptyHtml;
                return;
            }
            
            let santriCardsHtml = '';
            localCache.santri.forEach(santri => {
                santriCardsHtml += `
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg p-6 border border-indigo-200 hover:shadow-lg transition-all cursor-pointer santri-card" data-santri-nis="${santri.nis}">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-xl">${santri.nama.charAt(0)}</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800 text-lg">${santri.nama}</h4>
                                <p class="text-sm text-gray-600">NIS: ${santri.nis}</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">Kelas: ${santri.kelas}</span>
                            <span class="text-indigo-600 font-semibold">${santri.hafalan_juz} Juz</span>
                        </div>
                        <div class="mt-4 pt-3 border-t border-indigo-200">
                            <button class="view-report-btn w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 font-semibold text-sm">
                                <i class="fas fa-file-alt mr-2"></i>Lihat Laporan
                            </button>
                        </div>
                    </div>
                `;
            });
            
            if (weeklyList) weeklyList.innerHTML = santriCardsHtml;
            if (monthlyList) monthlyList.innerHTML = santriCardsHtml;
            if (raporList) raporList.innerHTML = santriCardsHtml;
            
            // Add event listeners
            attachReportClickListeners();
        }
        
        function attachReportClickListeners() {
            // Weekly report
            document.querySelectorAll('#weekly-santri-list .santri-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const nis = card.dataset.santriNis;
                    generateWeeklyReport(nis);
                });
            });
            
            // Monthly report
            document.querySelectorAll('#monthly-santri-list .santri-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const nis = card.dataset.santriNis;
                    generateMonthlyReport(nis);
                });
            });
            
            // Rapor
            document.querySelectorAll('#rapor-santri-list .santri-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const nis = card.dataset.santriNis;
                    generateRaporReport(nis);
                });
            });
            
            // Back buttons
            const btnBackWeekly = document.getElementById('btn-back-weekly');
            if (btnBackWeekly) {
                btnBackWeekly.addEventListener('click', () => {
                    document.getElementById('weekly-report-detail').classList.add('hidden');
                    document.querySelector('#content-laporan > .bg-white').classList.remove('hidden');
                });
            }
            
            const btnBackMonthly = document.getElementById('btn-back-monthly');
            if (btnBackMonthly) {
                btnBackMonthly.addEventListener('click', () => {
                    document.getElementById('monthly-report-detail').classList.add('hidden');
                    document.querySelector('#content-bulanan > .bg-white').classList.remove('hidden');
                });
            }
            
            const btnBackRapor = document.getElementById('btn-back-rapor');
            if (btnBackRapor) {
                btnBackRapor.addEventListener('click', () => {
                    document.getElementById('rapor-report-detail').classList.add('hidden');
                    document.querySelector('#content-rapor > .bg-white').classList.remove('hidden');
                });
            }
            
            // Download PDF buttons
            const btnDownloadWeekly = document.getElementById('btn-download-weekly');
            if (btnDownloadWeekly) {
                btnDownloadWeekly.addEventListener('click', () => {
                    downloadPDF('weekly-report-container', 'Laporan-Mingguan');
                });
            }
            
            const btnDownloadMonthly = document.getElementById('btn-download-monthly');
            if (btnDownloadMonthly) {
                btnDownloadMonthly.addEventListener('click', () => {
                    downloadPDF('monthly-report-container', 'Laporan-Bulanan');
                });
            }
            
            const btnDownloadRapor = document.getElementById('btn-download-rapor');
            if (btnDownloadRapor) {
                btnDownloadRapor.addEventListener('click', () => {
                    downloadPDF('rapor-report-container', 'Rapor-Semester');
                });
            }
        }
        
        function downloadPDF(containerId, filename) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            showToast('Membuat PDF...', 'info');
            
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `${filename}-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(container).save().then(() => {
                showToast('PDF berhasil didownload!', 'success');
            }).catch((error) => {
                console.error('Error generating PDF:', error);
                showToast('Gagal membuat PDF', 'error');
            });
        }

        function refreshSantriList() {
            const container = document.getElementById('santri-list-container');
            
            if (localCache.santri.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-user-friends text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-500">Belum ada santri. Tambahkan santri baru!</p>
                    </div>
                `;
                return;
            }

            let html = '';
            localCache.santri.forEach(santri => {
                html += `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold">${santri.nama.charAt(0)}</span>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800">${santri.nama}</h4>
                                <div class="flex items-center space-x-3 text-sm text-gray-500 mt-1">
                                    <span><i class="fas fa-id-card mr-1"></i>${santri.nis}</span>
                                    <span><i class="fas fa-school mr-1"></i>${santri.kelas}</span>
                                    <span><i class="fas fa-user-tie mr-1"></i>${santri.pembimbing || '-'}</span>
                                </div>
                                <div class="flex items-center space-x-3 text-sm mt-1">
                                    <span class="text-emerald-600 font-medium">
                                        <i class="fas fa-book-quran mr-1"></i>${santri.hafalan_juz} Juz
                                    </span>
                                    <span class="text-purple-600 font-medium">
                                        <i class="fas fa-file-alt mr-1"></i>${santri.hafalan_halaman} Halaman
                                    </span>
                                    <span class="text-amber-600 font-medium">
                                        <i class="fas fa-scroll mr-1"></i>${santri.hafalan_hadits || 0} Hadits
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="editSantri('${santri.id}')" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold text-sm transition-colors flex items-center">
                                <i class="fas fa-edit mr-2"></i>Edit
                            </button>
                            <button onclick="deleteSantri('${santri.id}', '${santri.nama}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold text-sm transition-colors flex items-center">
                                <i class="fas fa-trash mr-2"></i>Hapus
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Edit & Delete Santri Functions
        let editingSantriId = null;
        
        window.editSantri = function(santriId) {
            const santri = localCache.santri.find(s => s.id === santriId);
            if (!santri) return;
            
            editingSantriId = santriId;
            document.getElementById('santri-nis').value = santri.nis;
            document.getElementById('santri-nama').value = santri.nama;
            document.getElementById('santri-kelas').value = santri.kelas;
            document.getElementById('santri-wali').value = santri.wali || '';
            document.getElementById('santri-pembimbing').value = santri.pembimbing || '';
            document.getElementById('santri-hafalan-juz').value = santri.hafalan_juz;
            document.getElementById('santri-hafalan-halaman').value = santri.hafalan_halaman;
            document.getElementById('santri-hafalan-hadits').value = santri.hafalan_hadits || 0;
            
            document.getElementById('add-santri-btn-text').textContent = 'Update Santri';
            document.querySelector('#form-add-santri button[type="submit"]').classList.remove('bg-blue-600', 'hover:bg-blue-700');
            document.querySelector('#form-add-santri button[type="submit"]').classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            
            showToast('Mode Edit: Ubah data lalu klik Update', 'info');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        window.deleteSantri = async function(santriId, santriNama) {
            const deleteBtn = event.target.closest('button');
            const originalHtml = deleteBtn.innerHTML;
            
            if (!deleteBtn.classList.contains('confirm-delete')) {
                deleteBtn.classList.add('confirm-delete', 'bg-red-700');
                deleteBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Yakin Hapus?';
                
                setTimeout(() => {
                    deleteBtn.classList.remove('confirm-delete', 'bg-red-700');
                    deleteBtn.innerHTML = originalHtml;
                }, 3000);
                return;
            }
            
            try {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menghapus...';
                
                const { deleteDoc, doc } = window.firestore;
                const db = window.db;
                
                await deleteDoc(doc(db, 'santri', santriId));
                showToast(`${santriNama} berhasil dihapus!`, 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menghapus santri: ' + error.message, 'error');
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalHtml;
            }
        };

        // Form Handlers
        document.getElementById('form-sesi').addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading('sesi-btn-text', 'sesi-spinner', true);

            try {
                const { collection, addDoc } = window.firestore;
                const db = window.db;
                
                const data = {
                    nama: document.getElementById('sesi-nama').value,
                    jam_mulai: document.getElementById('sesi-jam-mulai').value,
                    jam_berakhir: document.getElementById('sesi-jam-berakhir').value,
                    created_at: new Date().toISOString()
                };

                await addDoc(collection(db, 'sesi'), data);
                showToast('Sesi berhasil ditambahkan!', 'success');
                e.target.reset();
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menyimpan sesi: ' + error.message, 'error');
            } finally {
                setLoading('sesi-btn-text', 'sesi-spinner', false);
            }
        });

        document.getElementById('form-absensi').addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading('absensi-btn-text', 'absensi-spinner', true);

            try {
                const { collection, addDoc } = window.firestore;
                const db = window.db;
                const santriSelect = document.getElementById('absensi-santri-select');
                const sesiSelect = document.getElementById('absensi-sesi');
                const selectedSantri = santriSelect.options[santriSelect.selectedIndex];
                const selectedSesi = sesiSelect.options[sesiSelect.selectedIndex];
                
                const data = {
                    santri_id: selectedSantri.dataset.nis,
                    santri_nama: selectedSantri.dataset.nama,
                    tanggal: document.getElementById('absensi-tanggal').value,
                    sesi_id: sesiSelect.value,
                    sesi_nama: selectedSesi.dataset.nama,
                    sesi_jam_mulai: selectedSesi.dataset.jamMulai,
                    sesi_jam_berakhir: selectedSesi.dataset.jamBerakhir,
                    status: document.getElementById('absensi-status').value,
                    created_at: new Date().toISOString()
                };

                await addDoc(collection(db, 'absensi'), data);
                showToast('Absensi berhasil disimpan!', 'success');
                e.target.reset();
                document.getElementById('absensi-tanggal').value = new Date().toISOString().split('T')[0];
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menyimpan absensi: ' + error.message, 'error');
            } finally {
                setLoading('absensi-btn-text', 'absensi-spinner', false);
            }
        });

        document.getElementById('form-add-santri').addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading('add-santri-btn-text', 'add-santri-spinner', true);

            try {
                const db = window.db;
                const santriData = {
                    nis: document.getElementById('santri-nis').value,
                    nama: document.getElementById('santri-nama').value,
                    kelas: document.getElementById('santri-kelas').value,
                    wali: document.getElementById('santri-wali').value,
                    pembimbing: document.getElementById('santri-pembimbing').value,
                    hafalan_juz: parseInt(document.getElementById('santri-hafalan-juz').value),
                    hafalan_halaman: parseInt(document.getElementById('santri-hafalan-halaman').value),
                    hafalan_hadits: parseInt(document.getElementById('santri-hafalan-hadits').value) || 0
                };

                if (editingSantriId) {
                    const { doc, updateDoc } = window.firestore;
                    santriData.updated_at = new Date().toISOString();
                    await updateDoc(doc(db, 'santri', editingSantriId), santriData);
                    showToast('Data santri berhasil diupdate!', 'success');
                    
                    editingSantriId = null;
                    document.getElementById('add-santri-btn-text').textContent = 'Tambah Santri';
                    document.querySelector('#form-add-santri button[type="submit"]').classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    document.querySelector('#form-add-santri button[type="submit"]').classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    const { collection, addDoc } = window.firestore;
                    santriData.created_at = new Date().toISOString();
                    await addDoc(collection(db, 'santri'), santriData);
                    showToast('Santri berhasil ditambahkan!', 'success');
                }
                
                e.target.reset();
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menyimpan data: ' + error.message, 'error');
            } finally {
                setLoading('add-santri-btn-text', 'add-santri-spinner', false);
            }
        });

        document.getElementById('form-tahfidz').addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading('tahfidz-btn-text', 'tahfidz-spinner', true);

            try {
                const { collection, addDoc } = window.firestore;
                const db = window.db;
                const select = document.getElementById('tahfidz-santri-select');
                const selectedOption = select.options[select.selectedIndex];
                
                const data = {
                    santri_id: selectedOption.dataset.nis,
                    santri_nama: selectedOption.dataset.nama,
                    tanggal: document.getElementById('tahfidz-tanggal').value,
                    juz: parseInt(document.getElementById('tahfidz-juz').value),
                    halaman: parseInt(document.getElementById('tahfidz-halaman').value),
                    nilai: document.getElementById('tahfidz-nilai').value,
                    created_at: new Date().toISOString()
                };

                await addDoc(collection(db, 'tahfidz'), data);
                showToast('Data Tahfidz berhasil disimpan!', 'success');
                e.target.reset();
                document.getElementById('tahfidz-tanggal').value = new Date().toISOString().split('T')[0];
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menyimpan data: ' + error.message, 'error');
            } finally {
                setLoading('tahfidz-btn-text', 'tahfidz-spinner', false);
            }
        });

        document.getElementById('form-tahsin').addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading('tahsin-btn-text', 'tahsin-spinner', true);

            try {
                const { collection, addDoc } = window.firestore;
                const db = window.db;
                const select = document.getElementById('tahsin-santri-select');
                const selectedOption = select.options[select.selectedIndex];
                
                const data = {
                    santri_id: selectedOption.dataset.nis,
                    santri_nama: selectedOption.dataset.nama,
                    tanggal: document.getElementById('tahsin-tanggal').value,
                    kategori: document.getElementById('tahsin-kategori').value,
                    nilai: document.getElementById('tahsin-nilai').value,
                    created_at: new Date().toISOString()
                };

                await addDoc(collection(db, 'tahsin'), data);
                showToast('Data Tahsin berhasil disimpan!', 'success');
                e.target.reset();
                document.getElementById('tahsin-tanggal').value = new Date().toISOString().split('T')[0];
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menyimpan data: ' + error.message, 'error');
            } finally {
                setLoading('tahsin-btn-text', 'tahsin-spinner', false);
            }
        });

        document.getElementById('form-murajaah').addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading('murajaah-btn-text', 'murajaah-spinner', true);

            try {
                const { collection, addDoc } = window.firestore;
                const db = window.db;
                const select = document.getElementById('murajaah-santri-select');
                const selectedOption = select.options[select.selectedIndex];
                
                const data = {
                    santri_id: selectedOption.dataset.nis,
                    santri_nama: selectedOption.dataset.nama,
                    tanggal: document.getElementById('murajaah-tanggal').value,
                    juz: parseInt(document.getElementById('murajaah-juz').value),
                    halaman: parseInt(document.getElementById('murajaah-halaman').value),
                    nilai: document.getElementById('murajaah-nilai').value,
                    created_at: new Date().toISOString()
                };

                await addDoc(collection(db, 'murajaah'), data);
                showToast('Data Murajaah berhasil disimpan!', 'success');
                e.target.reset();
                document.getElementById('murajaah-tanggal').value = new Date().toISOString().split('T')[0];
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menyimpan data: ' + error.message, 'error');
            } finally {
                setLoading('murajaah-btn-text', 'murajaah-spinner', false);
            }
        });

        document.getElementById('form-hadits').addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading('hadits-btn-text', 'hadits-spinner', true);

            try {
                const { collection, addDoc } = window.firestore;
                const db = window.db;
                const select = document.getElementById('hadits-santri-select');
                const selectedOption = select.options[select.selectedIndex];
                
                const data = {
                    santri_id: selectedOption.dataset.nis,
                    santri_nama: selectedOption.dataset.nama,
                    tanggal: document.getElementById('hadits-tanggal').value,
                    judul: document.getElementById('hadits-judul').value,
                    nilai: document.getElementById('hadits-nilai').value,
                    created_at: new Date().toISOString()
                };

                await addDoc(collection(db, 'hadits'), data);
                showToast('Data Hadits berhasil disimpan!', 'success');
                e.target.reset();
                document.getElementById('hadits-tanggal').value = new Date().toISOString().split('T')[0];
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menyimpan data: ' + error.message, 'error');
            } finally {
                setLoading('hadits-btn-text', 'hadits-spinner', false);
            }
        });

        // Auto-calculate nilai based on aktivitas checked
        function updateMutabaahNilai() {
            const checkboxes = document.querySelectorAll('input[name="aktivitas"]:checked');
            const count = checkboxes.length;
            const nilaiSelect = document.getElementById('mutabaah-nilai');
            
            let nilai = '';
            if (count === 11) {
                nilai = 'A';
            } else if (count >= 8 && count <= 10) {
                nilai = 'B';
            } else if (count >= 5 && count <= 7) {
                nilai = 'C';
            } else if (count >= 1 && count <= 4) {
                nilai = 'D';
            }
            
            nilaiSelect.value = nilai;
            
            // Update option text to show current count
            if (nilai) {
                nilaiSelect.options[0].text = `Nilai ${nilai} (${count}/11 aktivitas)`;
            } else {
                nilaiSelect.options[0].text = 'Centang aktivitas untuk mendapat nilai';
            }
        }
        
        // Add event listeners to all aktivitas checkboxes
        document.querySelectorAll('input[name="aktivitas"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateMutabaahNilai);
        });

        document.getElementById('form-mutabaah').addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading('mutabaah-btn-text', 'mutabaah-yaumiyah-spinner', true);

            try {
                const { collection, addDoc } = window.firestore;
                const db = window.db;
                const select = document.getElementById('mutabaah-santri-select');
                const selectedOption = select.options[select.selectedIndex];
                const checkboxes = document.querySelectorAll('input[name="aktivitas"]:checked');
                const aktivitas = Array.from(checkboxes).map(cb => cb.value);

                if (aktivitas.length === 0) {
                    showToast('Pilih minimal satu aktivitas!', 'error');
                    setLoading('mutabaah-btn-text', 'mutabaah-yaumiyah-spinner', false);
                    return;
                }
                
                const data = {
                    santri_id: selectedOption.dataset.nis,
                    santri_nama: selectedOption.dataset.nama,
                    tanggal: document.getElementById('mutabaah-tanggal').value,
                    nilai: document.getElementById('mutabaah-nilai').value,
                    aktivitas: aktivitas,
                    created_at: new Date().toISOString()
                };

                await addDoc(collection(db, 'mutabaah'), data);
                showToast('Mutabaah Yaumiyah berhasil disimpan!', 'success');
                e.target.reset();
                document.getElementById('mutabaah-tanggal').value = new Date().toISOString().split('T')[0];
                updateMutabaahNilai(); // Reset nilai display
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menyimpan data: ' + error.message, 'error');
            } finally {
                setLoading('mutabaah-btn-text', 'mutabaah-yaumiyah-spinner', false);
            }
        });

        // Report generators
        function generateWeeklyReport(santriNis) {
            const santri = localCache.santri.find(s => s.nis === santriNis);
            if (!santri) return;
            
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            
            const weekAgoStr = weekAgo.toISOString().split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            
            const santriTahfidz = localCache.tahfidz.filter(t => t.santri_id === santri.nis && t.tanggal >= weekAgoStr && t.tanggal <= todayStr);
            const santriTahsin = localCache.tahsin.filter(t => t.santri_id === santri.nis && t.tanggal >= weekAgoStr && t.tanggal <= todayStr);
            const santriMurajaah = localCache.murajaah.filter(t => t.santri_id === santri.nis && t.tanggal >= weekAgoStr && t.tanggal <= todayStr);
            const santriHadits = localCache.hadits.filter(t => t.santri_id === santri.nis && t.tanggal >= weekAgoStr && t.tanggal <= todayStr);
            const santriMutabaah = localCache.mutabaah.filter(t => t.santri_id === santri.nis && t.tanggal >= weekAgoStr && t.tanggal <= todayStr);
            const santriAbsensi = localCache.absensi.filter(t => t.santri_id === santri.nis && t.tanggal >= weekAgoStr && t.tanggal <= todayStr);
            
            // Hitung kehadiran
            const totalSesiDiharapkan = localCache.sesi.length * 7; // 7 hari
            const kehadiranHadir = santriAbsensi.filter(a => a.status === 'Hadir').length;
            const kehadiranIzin = santriAbsensi.filter(a => a.status === 'Izin').length;
            const kehadiranSakit = santriAbsensi.filter(a => a.status === 'Sakit').length;
            const kehadiranAlpa = santriAbsensi.filter(a => a.status === 'Alpa').length;
            const persentaseKehadiran = totalSesiDiharapkan > 0 ? Math.round((kehadiranHadir / totalSesiDiharapkan) * 100) : 0;
            
            const halamanBaruPeriode = santriTahfidz.length;
            const juzAwal = santri.hafalan_juz;
            const halamanAwal = santri.hafalan_halaman % 20;
            const totalHalamanDalamJuz = halamanAwal + halamanBaruPeriode;
            const tambahanJuz = Math.floor(totalHalamanDalamJuz / 20);
            const sisaHalamanSekarang = totalHalamanDalamJuz % 20;
            const totalJuzSekarang = juzAwal + tambahanJuz;
            
            const juzMurajaah = [...new Set(santriMurajaah.map(t => t.juz))];
            const halamanMurajaahPeriode = santriMurajaah.length;
            
            const nilaiTahsin = santriTahsin.reduce((acc, t) => {
                acc[t.nilai] = (acc[t.nilai] || 0) + 1;
                return acc;
            }, {});
            
            const nilaiHadits = santriHadits.reduce((acc, t) => {
                acc[t.nilai] = (acc[t.nilai] || 0) + 1;
                return acc;
            }, {});
            
            let reportHtml = `
                <div style="border: 2px solid #000; padding: 20px; background: #fff; font-family: 'Times New Roman', serif; color: #000;">
                    <div style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #000;">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSquCqPBndiUDFRhkSqzMeghINKap_pRxFY5A&s" style="width: 80px; height: 80px; margin-right: 15px; object-fit: contain;" alt="Logo">
                        <div style="flex: 1; text-align: center;">
                            <h2 style="margin: 0 0 10px 0; font-size: 18px; font-weight: bold; color: #000;">LAPORAN MINGGUAN TAHFIDZ</h2>
                            <h3 style="margin: 0 0 5px 0; font-size: 16px; font-weight: bold; color: #000;">MA'HAD ABU BAKAR ASH-SHIDDIQ ANABANUA</h3>
                            <p style="margin: 0; font-size: 11px; color: #000;">Kabupaten Wajo, Sulawesi Selatan</p>
                            <p style="margin: 5px 0 0 0; font-size: 11px; color: #000;">Periode: ${weekAgo.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })} - ${today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <table style="width: 100%; font-size: 12px; color: #000;">
                            <tr><td style="width: 150px; padding: 4px 0;">Nama Santri</td><td style="width: 10px;">:</td><td style="font-weight: bold;">${santri.nama}</td></tr>
                            <tr><td style="padding: 4px 0;">NIS</td><td>:</td><td>${santri.nis}</td></tr>
                            <tr><td style="padding: 4px 0;">Kelas</td><td>:</td><td>${santri.kelas}</td></tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 13px; font-weight: bold; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #000; color: #000;">CAPAIAN HAFALAN</h4>
                        <table style="width: 100%; font-size: 11px; border-collapse: collapse; color: #000;">
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; width: 40%; background: #f0f0f0; font-weight: bold;">Keterangan</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; background: #f0f0f0; font-weight: bold;">Capaian</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Hafalan Awal</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center;">${santri.hafalan_juz} Juz ${santri.hafalan_halaman % 20} Halaman</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Tambahan Minggu Ini</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${halamanBaruPeriode} Halaman</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">Total Sekarang</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold; background: #f0f0f0;">${totalJuzSekarang} Juz ${sisaHalamanSekarang} Halaman</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 13px; font-weight: bold; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #000; color: #000;">DETAIL AKTIVITAS</h4>
                        <table style="width: 100%; font-size: 11px; border-collapse: collapse; color: #000;">
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; background: #f0f0f0; font-weight: bold;">Tahsin</td>
                                <td style="border: 1px solid #000; padding: 6px;">${Object.keys(nilaiTahsin).length > 0 ? Object.entries(nilaiTahsin).map(([n, c]) => `${n}: ${c}x`).join(', ') : 'Belum ada data'}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; background: #f0f0f0; font-weight: bold;">Murajaah</td>
                                <td style="border: 1px solid #000; padding: 6px;">${juzMurajaah.length > 0 ? `${juzMurajaah.length} Juz (${halamanMurajaahPeriode} halaman)` : 'Belum ada data'}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; background: #f0f0f0; font-weight: bold;">Hadits</td>
                                <td style="border: 1px solid #000; padding: 6px;">${santriHadits.length > 0 ? `${santriHadits.length} hadits baru (${Object.entries(nilaiHadits).map(([n, c]) => `${n}: ${c}x`).join(', ')})` : 'Belum ada data'}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; background: #f0f0f0; font-weight: bold;">Mutabaah Yaumiyah</td>
                                <td style="border: 1px solid #000; padding: 6px;">${santriMutabaah.length > 0 ? `${santriMutabaah.length} hari tercatat` : 'Belum ada data'}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; background: #f0f0f0; font-weight: bold;">Kehadiran</td>
                                <td style="border: 1px solid #000; padding: 6px;">${persentaseKehadiran}% (Hadir: ${kehadiranHadir}, Izin: ${kehadiranIzin}, Sakit: ${kehadiranSakit}, Alpa: ${kehadiranAlpa})</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 20px; border: 1px solid #000; padding: 10px;">
                        <h5 style="font-size: 12px; font-weight: bold; margin: 0 0 8px 0; color: #000;">CATATAN PEMBIMBING:</h5>
                        <textarea id="catatan-weekly" style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid #999; font-size: 11px; font-family: 'Times New Roman', serif; resize: vertical;" placeholder="Tulis catatan pembimbing di sini..."></textarea>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <table style="width: 100%; font-size: 11px; color: #000;">
                            <tr>
                                <td style="width: 50%; text-align: center; vertical-align: top;">
    <div>
        <p style="margin: 0;">Mengetahui,</p>
        <p style="margin: 5px 0 50px 0; font-weight: bold;">Orang Tua / Wali</p>
        <p style="margin: 5px 0 0 0;">( ${santri.wali || '....................'} )</p>
        <div style="border-bottom: 1px solid #000; width: 180px; margin: 0 auto;"></div>
    </div>
</td>
                                <td style="width: 50%; text-align: center; vertical-align: top;">
    <div>
        <p style="margin: 0;">${today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
        <p style="margin: 5px 0 50px 0; font-weight: bold;">Pembimbing</p>
        <p style="margin: 5px 0 0 0;">( ${santri.pembimbing || '....................'} )</p>
        <div style="border-bottom: 1px solid #000; width: 180px; margin: 0 auto;"></div>
    </div>
</td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('weekly-report-container').innerHTML = reportHtml;
            document.getElementById('weekly-report-detail').classList.remove('hidden');
            document.querySelector('#content-laporan > .bg-white').classList.add('hidden');
        }

        function generateMonthlyReport(santriNis) {
            const santri = localCache.santri.find(s => s.nis === santriNis);
            if (!santri) return;
            
            const today = new Date();
            const monthAgo = new Date(today);
            monthAgo.setDate(today.getDate() - 30);
            
            const monthAgoStr = monthAgo.toISOString().split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            
            const santriTahfidz = localCache.tahfidz.filter(t => t.santri_id === santri.nis && t.tanggal >= monthAgoStr && t.tanggal <= todayStr);
            const santriTahsin = localCache.tahsin.filter(t => t.santri_id === santri.nis && t.tanggal >= monthAgoStr && t.tanggal <= todayStr);
            const santriMurajaah = localCache.murajaah.filter(t => t.santri_id === santri.nis && t.tanggal >= monthAgoStr && t.tanggal <= todayStr);
            const santriHadits = localCache.hadits.filter(t => t.santri_id === santri.nis && t.tanggal >= monthAgoStr && t.tanggal <= todayStr);
            const santriMutabaah = localCache.mutabaah.filter(t => t.santri_id === santri.nis && t.tanggal >= monthAgoStr && t.tanggal <= todayStr);
            const santriAbsensi = localCache.absensi.filter(t => t.santri_id === santri.nis && t.tanggal >= monthAgoStr && t.tanggal <= todayStr);
            
            // Hitung kehadiran
            const totalSesiDiharapkan = localCache.sesi.length * 30; // 30 hari
            const kehadiranHadir = santriAbsensi.filter(a => a.status === 'Hadir').length;
            const kehadiranIzin = santriAbsensi.filter(a => a.status === 'Izin').length;
            const kehadiranSakit = santriAbsensi.filter(a => a.status === 'Sakit').length;
            const kehadiranAlpa = santriAbsensi.filter(a => a.status === 'Alpa').length;
            const persentaseKehadiran = totalSesiDiharapkan > 0 ? Math.round((kehadiranHadir / totalSesiDiharapkan) * 100) : 0;
            
            const halamanBaruPeriode = santriTahfidz.length;
            const juzAwal = santri.hafalan_juz;
            const halamanAwal = santri.hafalan_halaman % 20;
            const totalHalamanDalamJuz = halamanAwal + halamanBaruPeriode;
            const tambahanJuz = Math.floor(totalHalamanDalamJuz / 20);
            const sisaHalamanSekarang = totalHalamanDalamJuz % 20;
            const totalJuzSekarang = juzAwal + tambahanJuz;
            
            const juzMurajaah = [...new Set(santriMurajaah.map(t => t.juz))];
            const halamanMurajaahPeriode = santriMurajaah.length;
            
            const nilaiTahsin = santriTahsin.reduce((acc, t) => {
                acc[t.nilai] = (acc[t.nilai] || 0) + 1;
                return acc;
            }, {});
            
            const nilaiHadits = santriHadits.reduce((acc, t) => {
                acc[t.nilai] = (acc[t.nilai] || 0) + 1;
                return acc;
            }, {});
            
            let reportHtml = `
                <div style="border: 2px solid #000; padding: 20px; background: #fff; font-family: 'Times New Roman', serif; color: #000;">
                    <div style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #000;">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSquCqPBndiUDFRhkSqzMeghINKap_pRxFY5A&s" style="width: 80px; height: 80px; margin-right: 15px; object-fit: contain;" alt="Logo">
                        <div style="flex: 1; text-align: center;">
                            <h2 style="margin: 0 0 10px 0; font-size: 18px; font-weight: bold; color: #000;">LAPORAN BULANAN TAHFIDZ</h2>
                            <h3 style="margin: 0 0 5px 0; font-size: 16px; font-weight: bold; color: #000;">MA'HAD ABU BAKAR ASH-SHIDDIQ ANABANUA</h3>
                            <p style="margin: 0; font-size: 11px; color: #000;">Kabupaten Wajo, Sulawesi Selatan</p>
                            <p style="margin: 5px 0 0 0; font-size: 11px; color: #000;">Periode: ${monthAgo.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })} - ${today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <table style="width: 100%; font-size: 12px; color: #000;">
                            <tr><td style="width: 150px; padding: 4px 0;">Nama Santri</td><td style="width: 10px;">:</td><td style="font-weight: bold;">${santri.nama}</td></tr>
                            <tr><td style="padding: 4px 0;">NIS</td><td>:</td><td>${santri.nis}</td></tr>
                            <tr><td style="padding: 4px 0;">Kelas</td><td>:</td><td>${santri.kelas}</td></tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 13px; font-weight: bold; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #000; color: #000;">CAPAIAN HAFALAN</h4>
                        <table style="width: 100%; font-size: 11px; border-collapse: collapse; color: #000;">
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; width: 40%; background: #f0f0f0; font-weight: bold;">Keterangan</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; background: #f0f0f0; font-weight: bold;">Capaian</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Hafalan Awal</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center;">${santri.hafalan_juz} Juz ${santri.hafalan_halaman % 20} Halaman</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Tambahan Bulan Ini</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${halamanBaruPeriode} Halaman</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">Total Sekarang</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold; background: #f0f0f0;">${totalJuzSekarang} Juz ${sisaHalamanSekarang} Halaman</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-size: 13px; font-weight: bold; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #000; color: #000;">DETAIL AKTIVITAS</h4>
                        <table style="width: 100%; font-size: 11px; border-collapse: collapse; color: #000;">
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; background: #f0f0f0; font-weight: bold;">Tahsin</td>
                                <td style="border: 1px solid #000; padding: 6px;">${Object.keys(nilaiTahsin).length > 0 ? Object.entries(nilaiTahsin).map(([n, c]) => `${n}: ${c}x`).join(', ') : 'Belum ada data'}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; background: #f0f0f0; font-weight: bold;">Murajaah</td>
                                <td style="border: 1px solid #000; padding: 6px;">${juzMurajaah.length > 0 ? `${juzMurajaah.length} Juz (${halamanMurajaahPeriode} halaman)` : 'Belum ada data'}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; background: #f0f0f0; font-weight: bold;">Hadits</td>
                                <td style="border: 1px solid #000; padding: 6px;">${santriHadits.length > 0 ? `${santriHadits.length} hadits baru (${Object.entries(nilaiHadits).map(([n, c]) => `${n}: ${c}x`).join(', ')})` : 'Belum ada data'}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; background: #f0f0f0; font-weight: bold;">Mutabaah Yaumiyah</td>
                                <td style="border: 1px solid #000; padding: 6px;">${santriMutabaah.length > 0 ? `${santriMutabaah.length} hari tercatat` : 'Belum ada data'}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; background: #f0f0f0; font-weight: bold;">Kehadiran</td>
                                <td style="border: 1px solid #000; padding: 6px;">${persentaseKehadiran}% (Hadir: ${kehadiranHadir}, Izin: ${kehadiranIzin}, Sakit: ${kehadiranSakit}, Alpa: ${kehadiranAlpa})</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 20px; border: 1px solid #000; padding: 10px;">
                        <h5 style="font-size: 12px; font-weight: bold; margin: 0 0 8px 0; color: #000;">CATATAN PEMBIMBING:</h5>
                        <textarea id="catatan-monthly" style="width: 100%; min-height: 80px; padding: 8px; border: 1px solid #999; font-size: 11px; font-family: 'Times New Roman', serif; resize: vertical;" placeholder="Tulis catatan pembimbing di sini..."></textarea>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <table style="width: 100%; font-size: 11px; color: #000;">
                            <tr>
                                <td style="width: 50%; text-align: center; vertical-align: top;">
    <div>
        <p style="margin: 0;">Mengetahui,</p>
        <p style="margin: 5px 0 50px 0; font-weight: bold;">Orang Tua / Wali</p>
        <p style="margin: 5px 0 0 0;">( ${santri.wali || '....................'} )</p>
        <div style="border-bottom: 1px solid #000; width: 180px; margin: 0 auto;"></div>
    </div>
</td>
                                <td style="width: 50%; text-align: center; vertical-align: top;">
    <div>
        <p style="margin: 0;">${today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
        <p style="margin: 5px 0 50px 0; font-weight: bold;">Pembimbing</p>
        <p style="margin: 5px 0 0 0;">( ${santri.pembimbing || '....................'} )</p>
        <div style="border-bottom: 1px solid #000; width: 180px; margin: 0 auto;"></div>
    </div>
</td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('monthly-report-container').innerHTML = reportHtml;
            document.getElementById('monthly-report-detail').classList.remove('hidden');
            document.querySelector('#content-bulanan > .bg-white').classList.add('hidden');
        }

        function generateRaporReport(santriNis) {
            const santri = localCache.santri.find(s => s.nis === santriNis);
            if (!santri) return;
            
            const today = new Date();
            const sixMonthsAgo = new Date(today);
            sixMonthsAgo.setMonth(today.getMonth() - 6);
            
            const startDateStr = sixMonthsAgo.toISOString().split('T')[0];
            const endDateStr = today.toISOString().split('T')[0];
            
            const santriTahfidz = localCache.tahfidz.filter(t => t.santri_id === santri.nis && t.tanggal >= startDateStr && t.tanggal <= endDateStr);
            const santriTahsin = localCache.tahsin.filter(t => t.santri_id === santri.nis && t.tanggal >= startDateStr && t.tanggal <= endDateStr);
            const santriMurajaah = localCache.murajaah.filter(t => t.santri_id === santri.nis && t.tanggal >= startDateStr && t.tanggal <= endDateStr);
            const santriHadits = localCache.hadits.filter(t => t.santri_id === santri.nis && t.tanggal >= startDateStr && t.tanggal <= endDateStr);
            const santriMutabaah = localCache.mutabaah.filter(t => t.santri_id === santri.nis && t.tanggal >= startDateStr && t.tanggal <= endDateStr);
            const santriAbsensi = localCache.absensi.filter(t => t.santri_id === santri.nis && t.tanggal >= startDateStr && t.tanggal <= endDateStr);
            
            // Hitung kehadiran
            const totalSesiDiharapkan = localCache.sesi.length * 180; // 6 bulan = ~180 hari
            const kehadiranHadir = santriAbsensi.filter(a => a.status === 'Hadir').length;
            const kehadiranIzin = santriAbsensi.filter(a => a.status === 'Izin').length;
            const kehadiranSakit = santriAbsensi.filter(a => a.status === 'Sakit').length;
            const kehadiranAlpa = santriAbsensi.filter(a => a.status === 'Alpa').length;
            const persentaseKehadiranSemester = totalSesiDiharapkan > 0 ? Math.round((kehadiranHadir / totalSesiDiharapkan) * 100) : 0;
            
            const halamanBaruPeriode = santriTahfidz.length;
            const juzAwal = santri.hafalan_juz;
            const halamanAwal = santri.hafalan_halaman % 20;
            const totalHalamanDalamJuz = halamanAwal + halamanBaruPeriode;
            const tambahanJuz = Math.floor(totalHalamanDalamJuz / 20);
            const sisaHalamanSekarang = totalHalamanDalamJuz % 20;
            const totalJuzSekarang = juzAwal + tambahanJuz;
            
            const juzMurajaah = [...new Set(santriMurajaah.map(t => t.juz))];
            
            const nilaiTahsinMap = { A: 4, B: 3, C: 2, D: 1 };
            let totalNilaiTahsin = 0;
            let countTahsin = santriTahsin.length;
            santriTahsin.forEach(t => {
                totalNilaiTahsin += nilaiTahsinMap[t.nilai] || 0;
            });
            const rataRataTahsin = countTahsin > 0 ? (totalNilaiTahsin / countTahsin).toFixed(2) : 0;
            const gradeTahsin = rataRataTahsin >= 3.5 ? 'A' : rataRataTahsin >= 2.5 ? 'B' : rataRataTahsin >= 1.5 ? 'C' : 'D';
            
            const nilaiHaditsMap = { A: 4, B: 3, C: 2, D: 1 };
            let totalNilaiHadits = 0;
            let countHadits = santriHadits.length;
            santriHadits.forEach(t => {
                totalNilaiHadits += nilaiHaditsMap[t.nilai] || 0;
            });
            const rataRataHadits = countHadits > 0 ? (totalNilaiHadits / countHadits).toFixed(2) : 0;
            const gradeHadits = rataRataHadits >= 3.5 ? 'A' : rataRataHadits >= 2.5 ? 'B' : rataRataHadits >= 1.5 ? 'C' : 'D';
            
            const totalHariMutabaah = santriMutabaah.length;
            
            let reportHtml = `
                <div style="border: 2px solid #000; padding: 20px; background: #fff; font-family: 'Times New Roman', serif; color: #000;">
                    <div style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #000;">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSquCqPBndiUDFRhkSqzMeghINKap_pRxFY5A&s" style="width: 80px; height: 80px; margin-right: 15px; object-fit: contain;" alt="Logo">
                        <div style="flex: 1; text-align: center;">
                            <h2 style="margin: 0 0 10px 0; font-size: 18px; font-weight: bold; color: #000;">RAPOR SEMESTER</h2>
                            <h3 style="margin: 0 0 5px 0; font-size: 16px; font-weight: bold; color: #000;">MA'HAD ABU BAKAR ASH-SHIDDIQ ANABANUA</h3>
                            <p style="margin: 0; font-size: 11px; color: #000;">Kabupaten Wajo, Sulawesi Selatan</p>
                            <p style="margin: 5px 0 0 0; font-size: 11px; color: #000;">Periode: ${sixMonthsAgo.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })} - ${today.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <table style="width: 100%; font-size: 12px; color: #000;">
                            <tr><td style="width: 150px; padding: 4px 0;">Nama Santri</td><td style="width: 10px;">:</td><td style="font-weight: bold;">${santri.nama}</td></tr>
                            <tr><td style="padding: 4px 0;">NIS</td><td>:</td><td>${santri.nis}</td></tr>
                            <tr><td style="padding: 4px 0;">Kelas</td><td>:</td><td>${santri.kelas}</td></tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 13px; font-weight: bold; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #000; color: #000;">CAPAIAN HAFALAN</h4>
                        <table style="width: 100%; font-size: 11px; border-collapse: collapse; color: #000;">
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; width: 40%; background: #f0f0f0; font-weight: bold;">Keterangan</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; background: #f0f0f0; font-weight: bold;">Capaian</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Hafalan Awal Semester</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${santri.hafalan_juz} Juz ${santri.hafalan_halaman % 20} Halaman</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Tambahan Hafalan Semester Ini</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${halamanBaruPeriode} Halaman</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; font-weight: bold;">Total Hafalan Sekarang</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold; background: #f0f0f0;">${totalJuzSekarang} Juz ${sisaHalamanSekarang} Halaman</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 13px; font-weight: bold; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #000; color: #000;">PENILAIAN</h4>
                        <table style="width: 100%; font-size: 11px; border-collapse: collapse; color: #000;">
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px; width: 40%; background: #f0f0f0; font-weight: bold;">Aspek Penilaian</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; background: #f0f0f0; font-weight: bold;">Nilai</td>
                                <td style="border: 1px solid #000; padding: 6px; background: #f0f0f0; font-weight: bold;">Keterangan</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Tahfidz (Hafalan Baru)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${halamanBaruPeriode > 50 ? 'A' : halamanBaruPeriode > 30 ? 'B' : halamanBaruPeriode > 15 ? 'C' : 'D'}</td>
                                <td style="border: 1px solid #000; padding: 6px;">${halamanBaruPeriode} halaman dalam 6 bulan</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Tahsin</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${gradeTahsin}</td>
                                <td style="border: 1px solid #000; padding: 6px;">Rata-rata: ${rataRataTahsin} (${countTahsin}x evaluasi)</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Murajaah (Mengulang Hafalan)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${juzMurajaah.length > 15 ? 'A' : juzMurajaah.length > 10 ? 'B' : juzMurajaah.length > 5 ? 'C' : 'D'}</td>
                                <td style="border: 1px solid #000; padding: 6px;">${juzMurajaah.length} juz dimurajaah</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Hafalan Hadits</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${gradeHadits}</td>
                                <td style="border: 1px solid #000; padding: 6px;">Rata-rata: ${rataRataHadits} (${countHadits} hadits)</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Mutabaah Yaumiyah (Ibadah Harian)</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${totalHariMutabaah >= 144 ? 'A' : totalHariMutabaah >= 117 ? 'B' : totalHariMutabaah >= 90 ? 'C' : 'D'}</td>
                                <td style="border: 1px solid #000; padding: 6px;">Konsistensi: ${Math.round((totalHariMutabaah / 180) * 100)}%</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 6px;">Kehadiran</td>
                                <td style="border: 1px solid #000; padding: 6px; text-align: center; font-weight: bold;">${persentaseKehadiranSemester >= 80 ? 'A' : persentaseKehadiranSemester >= 65 ? 'B' : persentaseKehadiranSemester >= 50 ? 'C' : 'D'}</td>
                                <td style="border: 1px solid #000; padding: 6px;">Hadir: ${kehadiranHadir}, Izin: ${kehadiranIzin}, Sakit: ${kehadiranSakit}, Alpa: ${kehadiranAlpa} (${persentaseKehadiranSemester}%)</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 20px; border: 1px solid #000; padding: 10px;">
                        <h5 style="font-size: 12px; font-weight: bold; margin: 0 0 8px 0; color: #000;">CATATAN & REKOMENDASI PEMBIMBING:</h5>
                        <textarea id="catatan-rapor" style="width: 100%; min-height: 100px; padding: 8px; border: 1px solid #999; font-size: 11px; font-family: 'Times New Roman', serif; resize: vertical;" placeholder="Tulis catatan semester, prestasi, dan rekomendasi pembimbing di sini..."></textarea>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <table style="width: 100%; font-size: 11px; color: #000;">
                            <tr>
                                <td style="width: 50%; text-align: center; vertical-align: top;">
    <div>
        <p style="margin: 0;">Mengetahui,</p>
        <p style="margin: 5px 0 50px 0; font-weight: bold;">Orang Tua / Wali</p>
        <p style="margin: 5px 0 0 0;">( ${santri.wali || '....................'} )</p>
        <div style="border-bottom: 1px solid #000; width: 180px; margin: 0 auto;"></div>
    </div>
</td>
                                <td style="width: 50%; text-align: center; vertical-align: top;">
    <div>
        <p style="margin: 0;">${today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
        <p style="margin: 5px 0 50px 0; font-weight: bold;">Pembimbing</p>
        <p style="margin: 5px 0 0 0;">( ${santri.pembimbing || '....................'} )</p>
        <div style="border-bottom: 1px solid #000; width: 180px; margin: 0 auto;"></div>
    </div>
</td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('rapor-report-container').innerHTML = reportHtml;
            document.getElementById('rapor-report-detail').classList.remove('hidden');
            document.querySelector('#content-rapor > .bg-white').classList.add('hidden');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tahfidz-tanggal').value = today;
            document.getElementById('tahsin-tanggal').value = today;
            document.getElementById('murajaah-tanggal').value = today;
            document.getElementById('hadits-tanggal').value = today;
            document.getElementById('mutabaah-tanggal').value = today;
            document.getElementById('absensi-tanggal').value = today;
            
            const waitForFirebase = setInterval(() => {
                if (window.db && window.firestore) {
                    clearInterval(waitForFirebase);
                    initFirebaseListeners();
                }
            }, 100);
        });
    </script>
  // Fungsi Refresh Daftar Pembimbing
function refreshPembimbingList() {
    const container = document.getElementById('pembimbing-list');
    if (localCache.pembimbing.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Belum ada pembimbing</p>';
        return;
    }
    let html = '';
    localCache.pembimbing.forEach(p => {
        html += `
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg bg-gray-50">
                <div>
                    <p class="font-semibold text-gray-800">${p.nama}</p>
                    <p class="text-xs text-gray-500">${p.jabatan || '-'}</p>
                </div>
                <div class="flex space-x-1">
                    <button onclick="editPembimbing('${p.id}')" class="p-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-xs"><i class="fas fa-edit"></i></button>
                    <button onclick="deletePembimbing('${p.id}', '${p.nama}')" class="p-2 bg-red-500 text-white rounded hover:bg-red-600 text-xs"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
    });
    container.innerHTML = html;
}

// Handler Form Simpan/Update
document.getElementById('form-pembimbing').addEventListener('submit', async (e) => {
    e.preventDefault();
    setLoading('pembimbing-btn-text', 'pembimbing-spinner', true);
    try {
        const id = document.getElementById('pembimbing-id').value;
        const data = {
            nama: document.getElementById('pembimbing-nama').value,
            jabatan: document.getElementById('pembimbing-jabatan').value,
            updated_at: new Date().toISOString()
        };
        if (id) {
            await window.firestore.updateDoc(window.firestore.doc(window.db, 'pembimbing', id), data);
            showToast('Pembimbing diperbarui!', 'success');
        } else {
            data.created_at = new Date().toISOString();
            await window.firestore.addDoc(window.firestore.collection(window.db, 'pembimbing'), data);
            showToast('Pembimbing ditambahkan!', 'success');
        }
        resetFormPembimbing();
    } catch (error) {
        showToast('Gagal: ' + error.message, 'error');
    } finally {
        setLoading('pembimbing-btn-text', 'pembimbing-spinner', false);
    }
});

window.editPembimbing = function(id) {
    const p = localCache.pembimbing.find(item => item.id === id);
    if (!p) return;
    document.getElementById('pembimbing-id').value = p.id;
    document.getElementById('pembimbing-nama').value = p.nama;
    document.getElementById('pembimbing-jabatan').value = p.jabatan || '';
    document.getElementById('pembimbing-form-title').innerText = 'Edit Pembimbing';
    document.getElementById('pembimbing-btn-text').innerText = 'Update Pembimbing';
    document.getElementById('btn-cancel-pembimbing').classList.remove('hidden');
};

window.deletePembimbing = async function(id, nama) {
    if (confirm(`Hapus pembimbing ${nama}?`)) {
        try {
            await window.firestore.deleteDoc(window.firestore.doc(window.db, 'pembimbing', id));
            showToast('Berhasil dihapus', 'success');
        } catch (e) { showToast('Gagal hapus', 'error'); }
    }
};

function resetFormPembimbing() {
    document.getElementById('form-pembimbing').reset();
    document.getElementById('pembimbing-id').value = '';
    document.getElementById('pembimbing-form-title').innerText = 'Tambah Pembimbing';
    document.getElementById('pembimbing-btn-text').innerText = 'Simpan Pembimbing';
    document.getElementById('btn-cancel-pembimbing').classList.add('hidden');
}

document.getElementById('btn-cancel-pembimbing').onclick = resetFormPembimbing;

// Tambahkan 'pembimbing' ke dalam array di switchPanel
// Cari baris: const panels = ['dashboard', 'santri', ...];
// Ubah menjadi:
const panels = ['dashboard', 'santri', 'tahfidz', 'tahsin', 'murajaah', 'hadits', 'mutabaah', 'sesi', 'absensi', 'laporan', 'bulanan', 'rapor', 'pembimbing'];
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b7e1534f0875f60',t:'MTc2NzM5NzAzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
