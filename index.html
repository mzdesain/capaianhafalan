<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Manajemen Ketahfizan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script><!-- Firebase SDK -->
  <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
  apiKey: "AIzaSyAxoe-Bg6WUn59KjzaunvkCRVUbi1X95PQ",
  authDomain: "tahfidzmabash.firebaseapp.com",
  projectId: "tahfidzmabash",
  storageBucket: "tahfidzmabash.firebasestorage.app",
  messagingSenderId: "113529956394",
  appId: "1:113529956394:web:d6c9eedda4014fae937b53",
  measurementId: "G-GN5B5DLSPH"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, query, orderBy, onSnapshot, deleteDoc, doc, updateDoc };
    </script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .nav-item {
            transition: all 0.2s ease;
        }
        
        .nav-item:hover {
            background-color: rgba(79, 70, 229, 0.1);
        }
        
        .nav-item.active {
            background-color: #4f46e5;
            color: white;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="flex h-full w-full bg-gray-50"><!-- Sidebar -->
   <aside class="w-16 bg-white shadow-lg border-r border-gray-200 flex flex-col h-full">
    <div class="p-2 border-b border-gray-200">
     <div class="flex items-center justify-center"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSquCqPBndiUDFRhkSqzMeghINKap_pRxFY5A&amp;s" alt="Logo" class="w-10 h-10 rounded-lg object-contain">
     </div>
    </div>
    <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
    <button onclick="switchPanel('dashboard')" class="nav-item active w-full flex items-center justify-center p-3 rounded-lg" title="Dashboard"> <i class="fas fa-th-large text-lg"></i> </button>
    <button onclick="switchPanel('pembimbing-admin')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Kelola Master Pembimbing"> <i class="fas fa-user-shield text-lg"></i> </button>
    <button onclick="switchPanel('pilih-pembimbing')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Daftar Pembimbing"> <i class="fas fa-chalkboard-teacher text-lg"></i> </button>
    
    <div class="border-t border-gray-200 my-2"></div>
    
    <div id="pembimbing-sub-menu" class="hidden space-y-1">
        <button onclick="switchPanel('santri')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Kelola Santri"> <i class="fas fa-users text-lg"></i> </button>
        <button onclick="switchPanel('tahfidz')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Input Tahfidz"> <i class="fas fa-book text-lg"></i> </button>
        <button onclick="switchPanel('absensi')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Input Absensi"> <i class="fas fa-clipboard-check text-lg"></i> </button>
        <button onclick="switchPanel('laporan')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Laporan & Rapor"> <i class="fas fa-file-invoice text-lg"></i> </button>
    </div>
    
    <div class="border-t border-gray-200 my-2"></div>
    <button onclick="switchPanel('sesi')" class="nav-item w-full flex items-center justify-center p-3 rounded-lg text-gray-600" title="Kelola Sesi"> <i class="fas fa-clock text-lg"></i> </button>
</nav>
   </aside><!-- Main Content -->
   <main class="flex-1 overflow-auto"><!-- Dashboard Content -->
    <div id="content-dashboard" class="content-panel p-6">
     <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-500">Total Santri</p>
         <p id="stat-santri" class="text-3xl font-bold text-gray-800 mt-2">0</p>
        </div>
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"><i class="fas fa-users text-blue-600 text-xl"></i>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-500">Input Tahfidz</p>
         <p id="stat-tahfidz" class="text-3xl font-bold text-gray-800 mt-2">0</p>
        </div>
        <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center"><i class="fas fa-book text-indigo-600 text-xl"></i>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-500">Input Tahsin</p>
         <p id="stat-tahsin" class="text-3xl font-bold text-gray-800 mt-2">0</p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"><i class="fas fa-check-circle text-green-600 text-xl"></i>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-500">Input Murajaah</p>
         <p id="stat-murajaah" class="text-3xl font-bold text-gray-800 mt-2">0</p>
        </div>
        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center"><i class="fas fa-sync-alt text-purple-600 text-xl"></i>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-500">Input Hadits</p>
         <p id="stat-hadits" class="text-3xl font-bold text-gray-800 mt-2">0</p>
        </div>
        <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center"><i class="fas fa-scroll text-amber-600 text-xl"></i>
        </div>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><i class="fas fa-bolt text-yellow-500 mr-2"></i> Quick Actions</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4"><button onclick="switchPanel('tahfidz')" class="flex items-center space-x-3 p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition duration-200"> <i class="fas fa-plus-circle text-indigo-600 text-2xl"></i>
        <div class="text-left">
         <p class="font-semibold text-gray-800">Input Data Baru</p>
         <p class="text-xs text-gray-500">Tambah data harian santri</p>
        </div></button> <button onclick="switchPanel('laporan')" class="flex items-center space-x-3 p-4 bg-green-50 hover:bg-green-100 rounded-lg transition duration-200"> <i class="fas fa-file-alt text-green-600 text-2xl"></i>
        <div class="text-left">
         <p class="font-semibold text-gray-800">Lihat Laporan</p>
         <p class="text-xs text-gray-500">Generate laporan mingguan</p>
        </div></button> <button onclick="switchPanel('bulanan')" class="flex items-center space-x-3 p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition duration-200"> <i class="fas fa-chart-bar text-purple-600 text-2xl"></i>
        <div class="text-left">
         <p class="font-semibold text-gray-800">Laporan Bulanan</p>
         <p class="text-xs text-gray-500">Ringkasan bulanan</p>
        </div></button>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
     <div id="content-pembimbing-admin" class="content-panel hidden p-6">
    <div class="max-w-4xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-gray-800 mb-4">Tambah Pembimbing</h3>
                <form id="form-add-pembimbing" class="space-y-4">
                    <input type="text" id="pembimbing-nama" placeholder="Nama Lengkap Ustadz" required class="w-full px-4 py-2 border rounded-lg">
                    <input type="text" id="pembimbing-nip" placeholder="NIP/ID (Opsional)" class="w-full px-4 py-2 border rounded-lg">
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Simpan</button>
                </form>
            </div>
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="font-bold text-gray-800 mb-4">Daftar Pembimbing</h3>
                <div id="pembimbing-master-list" class="space-y-2"></div>
            </div>
        </div>
    </div>
</div>

<div id="content-pilih-pembimbing" class="content-panel hidden p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">Pilih Pembimbing untuk Mengelola Data</h2>
    <div id="grid-pembimbing" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
        </div>
</div>
    </div><!-- Kelola Santri Content -->
    <div id="content-santri" class="content-panel hidden p-6">
     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-user-plus text-blue-600 mr-2"></i> Tambah Santri</h3>
       <form id="form-add-santri" class="space-y-4">
        <div><label for="santri-nis" class="block text-sm font-medium text-gray-700 mb-2">NIS</label> <input type="text" id="santri-nis" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div><label for="santri-nama" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label> <input type="text" id="santri-nama" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div><label for="santri-kelas" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label> <input type="text" id="santri-kelas" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
    <label for="santri-wali" class="block text-sm font-medium text-gray-700 mb-2">Nama Orang Tua / Wali</label>
    <input type="text" id="santri-wali" required placeholder="Nama Ayah/Ibu/Wali" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
</div>
        <div>
    <label for="santri-pembimbing" class="block text-sm font-medium text-gray-700 mb-2">Nama Pembimbing</label>
    <input type="text" id="santri-pembimbing" required placeholder="Contoh: Ust. Ahmad" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
</div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="santri-hafalan-juz" class="block text-sm font-medium text-gray-700 mb-2">Total Hafalan Juz</label> <input type="number" id="santri-hafalan-juz" min="0" max="30" placeholder="0-30" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
         </div>
         <div><label for="santri-hafalan-halaman" class="block text-sm font-medium text-gray-700 mb-2">Total Hafalan Halaman</label> <input type="number" id="santri-hafalan-halaman" min="0" max="604" placeholder="0-604" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
         </div>
        </div>
        <div><label for="santri-hafalan-hadits" class="block text-sm font-medium text-gray-700 mb-2">Total Hafalan Hadits</label> <input type="number" id="santri-hafalan-hadits" min="0" placeholder="0" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div><button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="add-santri-btn-text">Tambah Santri</span>
         <div id="add-santri-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
      <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-users text-indigo-600 mr-2"></i> Daftar Santri</h3>
       <div id="santri-list-container" class="space-y-3">
        <div class="text-center py-12"><i class="fas fa-user-friends text-gray-300 text-5xl mb-4"></i>
         <p class="text-gray-500">Belum ada santri. Tambahkan santri baru!</p>
        </div>
       </div>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Input Tahfidz Content -->
    <div id="content-tahfidz" class="content-panel hidden p-6">
     <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-book text-indigo-600 mr-3 text-2xl"></i> Input Tahfidz</h3>
       <form id="form-tahfidz" class="space-y-4">
        <div><label for="tahfidz-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="tahfidz-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="tahfidz-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="tahfidz-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="tahfidz-juz" class="block text-sm font-medium text-gray-700 mb-2">Juz</label> <input type="number" id="tahfidz-juz" min="1" max="30" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
         </div>
         <div><label for="tahfidz-halaman" class="block text-sm font-medium text-gray-700 mb-2">Halaman</label> <input type="number" id="tahfidz-halaman" min="1" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
         </div>
        </div>
        <div><label for="tahfidz-nilai" class="block text-sm font-medium text-gray-700 mb-2">Nilai</label> <select id="tahfidz-nilai" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"> <option value="">Pilih Nilai</option> <option value="A">A - Sangat Baik</option> <option value="B">B - Baik</option> <option value="C">C - Cukup</option> <option value="D">D - Kurang</option> </select>
        </div><button type="submit" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="tahfidz-btn-text">Simpan Tahfidz</span>
         <div id="tahfidz-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Input Tahsin Content -->
    <div id="content-tahsin" class="content-panel hidden p-6">
     <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-check-circle text-green-600 mr-3 text-2xl"></i> Input Tahsin</h3>
       <form id="form-tahsin" class="space-y-4">
        <div><label for="tahsin-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="tahsin-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="tahsin-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="tahsin-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div><label for="tahsin-kategori" class="block text-sm font-medium text-gray-700 mb-2">Kategori</label> <select id="tahsin-kategori" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">Pilih Kategori</option> <option value="Makhorijul Huruf">Makhorijul Huruf</option> <option value="Tajwid">Tajwid</option> </select>
        </div>
        <div><label for="tahsin-nilai" class="block text-sm font-medium text-gray-700 mb-2">Nilai</label> <select id="tahsin-nilai" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">Pilih Nilai</option> <option value="A">A - Sangat Baik</option> <option value="B">B - Baik</option> <option value="C">C - Cukup</option> <option value="D">D - Kurang</option> </select>
        </div><button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="tahsin-btn-text">Simpan Tahsin</span>
         <div id="tahsin-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Input Murajaah Content -->
    <div id="content-murajaah" class="content-panel hidden p-6">
     <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-sync-alt text-purple-600 mr-3 text-2xl"></i> Input Murajaah</h3>
       <form id="form-murajaah" class="space-y-4">
        <div><label for="murajaah-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="murajaah-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="murajaah-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="murajaah-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="murajaah-juz" class="block text-sm font-medium text-gray-700 mb-2">Juz</label> <input type="number" id="murajaah-juz" min="1" max="30" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
         </div>
         <div><label for="murajaah-halaman" class="block text-sm font-medium text-gray-700 mb-2">Halaman</label> <input type="number" id="murajaah-halaman" min="1" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
         </div>
        </div>
        <div><label for="murajaah-nilai" class="block text-sm font-medium text-gray-700 mb-2">Nilai</label> <select id="murajaah-nilai" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"> <option value="">Pilih Nilai</option> <option value="A">A - Sangat Baik</option> <option value="B">B - Baik</option> <option value="C">C - Cukup</option> <option value="D">D - Kurang</option> </select>
        </div><button type="submit" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="murajaah-btn-text">Simpan Murajaah</span>
         <div id="murajaah-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Input Hadits Content -->
    <div id="content-hadits" class="content-panel hidden p-6">
     <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-scroll text-amber-600 mr-3 text-2xl"></i> Input Hadits</h3>
       <form id="form-hadits" class="space-y-4">
        <div><label for="hadits-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="hadits-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="hadits-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="hadits-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
        </div>
        <div><label for="hadits-judul" class="block text-sm font-medium text-gray-700 mb-2">Hadits ke-</label> <input type="number" id="hadits-judul" placeholder="Contoh: 1, 2, 3..." min="1" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
        </div>
        <div><label for="hadits-nilai" class="block text-sm font-medium text-gray-700 mb-2">Nilai</label> <select id="hadits-nilai" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"> <option value="">Pilih Nilai</option> <option value="A">A - Sangat Baik</option> <option value="B">B - Baik</option> <option value="C">C - Cukup</option> <option value="D">D - Kurang</option> </select>
        </div><button type="submit" class="w-full bg-amber-600 text-white py-3 px-4 rounded-lg hover:bg-amber-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="hadits-btn-text">Simpan Hadits</span>
         <div id="hadits-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Mutabaah Yaumiyah Content -->
    <div id="content-mutabaah" class="content-panel hidden p-6">
     <div class="max-w-3xl mx-auto">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-tasks text-teal-600 mr-3 text-2xl"></i> Mutabaah Yaumiyah</h3>
       <form id="form-mutabaah" class="space-y-6">
        <div><label for="mutabaah-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="mutabaah-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="mutabaah-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="mutabaah-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
        </div>
        <div><label for="mutabaah-nilai" class="block text-sm font-medium text-gray-700 mb-2">Nilai (Otomatis berdasarkan kelengkapan)</label> <select id="mutabaah-nilai" required disabled class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed"> <option value="">Centang aktivitas untuk mendapat nilai</option> <option value="A">A - Sangat Baik (11 aktivitas)</option> <option value="B">B - Baik (8-10 aktivitas)</option> <option value="C">C - Cukup (5-7 aktivitas)</option> <option value="D">D - Kurang (1-4 aktivitas)</option> </select>
        </div><!-- Aktivitas Harian -->
        <div>
         <h4 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-clipboard-list text-teal-600 mr-2"></i> Aktivitas Harian</h4>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-3"><label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Subuh" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Subuh</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Zhuhur" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Zhuhur</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Ashar" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Ashar</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Maghrib" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Maghrib</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Isya'" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Isya'</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Rawatib" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Rawatib</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Dhuha" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Dhuha</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Dzikir Pagi-Petang" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Dzikir Pagi-Petang</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Shalat Lail" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Shalat Lail</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Puasa Sunnah" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Puasa Sunnah</span> </label> <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="aktivitas" value="Hafal Hadits" class="w-5 h-5 text-teal-600 rounded focus:ring-teal-500"> <span class="ml-3 text-gray-700">Hafal Hadits</span> </label>
         </div>
        </div><button type="submit" class="w-full bg-teal-600 text-white py-3 px-4 rounded-lg hover:bg-teal-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="mutabaah-btn-text">Simpan Mutabaah</span>
         <div id="mutabaah-yaumiyah-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Kelola Sesi Content -->
    <div id="content-sesi" class="content-panel hidden p-6">
     <div class="max-w-4xl mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Form Kelola Sesi -->
       <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-clock text-blue-600 mr-2"></i> Tambah Sesi Baru</h3>
        <form id="form-sesi" class="space-y-4">
         <div><label for="sesi-nama" class="block text-sm font-medium text-gray-700 mb-2">Nama Sesi</label> <input type="text" id="sesi-nama" placeholder="Contoh: Subuh, Dzuhur" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
         </div>
         <div class="grid grid-cols-2 gap-4">
          <div><label for="sesi-jam-mulai" class="block text-sm font-medium text-gray-700 mb-2">Jam Mulai</label> <input type="time" id="sesi-jam-mulai" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div><label for="sesi-jam-berakhir" class="block text-sm font-medium text-gray-700 mb-2">Jam Berakhir</label> <input type="time" id="sesi-jam-berakhir" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
         </div><button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 font-semibold flex items-center justify-center"> <i class="fas fa-plus mr-2"></i> <span id="sesi-btn-text">Tambah Sesi</span>
          <div id="sesi-spinner" class="loading-spinner ml-2 hidden"></div></button>
        </form>
       </div><!-- Daftar Sesi -->
       <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-list text-indigo-600 mr-2"></i> Daftar Sesi</h3>
        <div id="sesi-list" class="space-y-2">
         <p class="text-sm text-gray-500 text-center py-8">Belum ada sesi</p>
        </div>
       </div>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Input Absensi Content -->
    <div id="content-absensi" class="content-panel hidden p-6">
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Form Input Absensi -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-clipboard-check text-green-600 mr-2"></i> Input Absensi</h3>
       <form id="form-absensi" class="space-y-4">
        <div><label for="absensi-santri-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Santri</label> <select id="absensi-santri-select" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="absensi-tanggal" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label> <input type="date" id="absensi-tanggal" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
        </div>
        <div><label for="absensi-sesi" class="block text-sm font-medium text-gray-700 mb-2">Sesi</label> <select id="absensi-sesi" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">-- Pilih Sesi --</option> </select>
        </div>
        <div><label for="absensi-status" class="block text-sm font-medium text-gray-700 mb-2">Status</label> <select id="absensi-status" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"> <option value="">Pilih Status</option> <option value="Hadir">✓ Hadir</option> <option value="Izin">⊗ Izin</option> <option value="Sakit">+ Sakit</option> <option value="Alpa">✗ Alpa</option> </select>
        </div><button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 font-semibold flex items-center justify-center"> <i class="fas fa-save mr-2"></i> <span id="absensi-btn-text">Simpan Absensi</span>
         <div id="absensi-spinner" class="loading-spinner ml-2 hidden"></div></button>
       </form>
      </div><!-- Riwayat Absensi -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
       <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-history text-purple-600 mr-2"></i> Riwayat Absensi</h3>
       <div id="absensi-history-container" class="space-y-3 max-h-[600px] overflow-y-auto">
        <div class="text-center py-8"><i class="fas fa-clipboard-list text-gray-300 text-4xl mb-3"></i>
         <p class="text-gray-500 text-sm">Belum ada data absensi</p>
        </div>
       </div>
      </div>
     </div><!-- Footer -->
     <div class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-600">
      <p class="mb-1">© 2025 Sistem Manajemen Tahfidz</p>
      <p>Created by <span class="font-bold">Muzanni</span></p>
     </div>
    </div><!-- Laporan Mingguan Content -->
    <div id="content-laporan" class="content-panel hidden p-6">
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-chart-line text-indigo-600 mr-3"></i> Laporan Mingguan - Pilih Santri</h3>
      <div id="weekly-santri-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
       <div class="text-center py-12 col-span-full"><i class="fas fa-users text-gray-300 text-5xl mb-4"></i>
        <p class="text-gray-500">Belum ada santri</p>
       </div>
      </div>
     </div><!-- Detail Laporan (Hidden by default) -->
     <div id="weekly-report-detail" class="hidden mt-6 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex justify-between items-center mb-6 no-print"><button id="btn-back-weekly" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"> <i class="fas fa-arrow-left mr-2"></i> Kembali ke Daftar </button> <button id="btn-download-weekly" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center"> <i class="fas fa-download mr-2"></i> Download PDF </button>
      </div>
      <div id="weekly-report-container"></div>
     </div>
    </div><!-- Laporan Bulanan Content -->
    <div id="content-bulanan" class="content-panel hidden p-6">
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-calendar-alt text-indigo-600 mr-3"></i> Laporan Bulanan - Pilih Santri</h3>
      <div id="monthly-santri-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
       <div class="text-center py-12 col-span-full"><i class="fas fa-users text-gray-300 text-5xl mb-4"></i>
        <p class="text-gray-500">Belum ada santri</p>
       </div>
      </div>
     </div><!-- Detail Laporan (Hidden by default) -->
     <div id="monthly-report-detail" class="hidden mt-6 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex justify-between items-center mb-6 no-print"><button id="btn-back-monthly" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"> <i class="fas fa-arrow-left mr-2"></i> Kembali ke Daftar </button> <button id="btn-download-monthly" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center"> <i class="fas fa-download mr-2"></i> Download PDF </button>
      </div>
      <div id="monthly-report-container"></div>
     </div>
    </div><!-- Rapor Semester Content -->
    <div id="content-rapor" class="content-panel hidden p-6">
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-file-invoice text-indigo-600 mr-3"></i> Rapor Semester - Pilih Santri</h3>
      <div id="rapor-santri-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
       <div class="text-center py-12 col-span-full"><i class="fas fa-users text-gray-300 text-5xl mb-4"></i>
        <p class="text-gray-500">Belum ada santri</p>
       </div>
      </div>
     </div><!-- Detail Rapor (Hidden by default) -->
     <div id="rapor-report-detail" class="hidden mt-6 bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex justify-between items-center mb-6 no-print"><button id="btn-back-rapor" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center"> <i class="fas fa-arrow-left mr-2"></i> Kembali ke Daftar </button> <button id="btn-download-rapor" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center"> <i class="fas fa-download mr-2"></i> Download PDF </button>
      </div>
      <div id="rapor-report-container"></div>
     </div>
    </div>
   </main>
  </div>
  <script type="module">
    // 1. GLOBAL STATE & CACHE
const localCache = {
    pembimbing: [],
    santri: [],
    tahfidz: [],
    tahsin: [],
    murajaah: [],
    hadits: [],
    mutabaah: [],
    sesi: [],
    absensi: [],
    selectedPembimbing: localStorage.getItem('selectedPembimbing') || null
};

// 2. FIREBASE LISTENERS
async function initFirebaseListeners() {
    const { onSnapshot, collection, query, orderBy } = window.firestore;
    const db = window.db;

    onSnapshot(query(collection(db, 'pembimbing'), orderBy('nama', 'asc')), (snap) => {
        localCache.pembimbing = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        refreshPembimbingUI();
    });

    onSnapshot(query(collection(db, 'santri'), orderBy('nama', 'asc')), (snap) => {
        localCache.santri = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        refreshSantriList();
        populateSantriSelects();
        updateStats();
    });

    const collections = ['tahfidz', 'tahsin', 'murajaah', 'hadits', 'mutabaah', 'sesi', 'absensi'];
    collections.forEach(col => {
        onSnapshot(collection(db, col), (snap) => {
            localCache[col] = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (col === 'sesi') populateSesiSelect();
            updateStats();
        });
    });
}

// 3. LOGIKA NAVIGASI
window.switchPanel = function(panelName) {
    const protectedPanels = ['santri', 'tahfidz', 'absensi', 'laporan', 'bulanan', 'rapor'];
    if (protectedPanels.includes(panelName) && !localCache.selectedPembimbing) {
        showToast("Pilih Pembimbing terlebih dahulu!", "error");
        switchPanel('pilih-pembimbing');
        return;
    }

    document.querySelectorAll('.content-panel').forEach(p => p.classList.add('hidden'));
    const target = document.getElementById(`content-${panelName}`);
    if (target) target.classList.remove('hidden');

    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-600', 'text-white');
        if (btn.getAttribute('onclick')?.includes(`'${panelName}'`)) {
            btn.classList.add('active', 'bg-indigo-600', 'text-white');
        }
    });
};

// 4. LOGIKA PEMBIMBING
window.pilihPembimbing = function(id, nama) {
    localCache.selectedPembimbing = nama;
    localStorage.setItem('selectedPembimbing', nama);
    document.getElementById('pembimbing-sub-menu').classList.remove('hidden');
    showToast(`Aktif: ${nama}`, 'success');
    refreshSantriList();
    populateSantriSelects();
    switchPanel('santri');
};

function refreshPembimbingUI() {
    const grid = document.getElementById('grid-pembimbing');
    if (!grid) return;
    grid.innerHTML = '';
    localCache.pembimbing.forEach(p => {
        grid.innerHTML += `
            <div onclick="pilihPembimbing('${p.id}', '${p.nama}')" class="bg-white p-6 rounded-xl border hover:border-indigo-500 cursor-pointer text-center transition-all shadow-sm">
                <i class="fas fa-user-tie text-2xl mb-2 text-indigo-600"></i>
                <h3 class="font-bold text-gray-800">${p.nama}</h3>
            </div>`;
    });
}

// 5. LOGIKA SANTRI & SELECTS
function refreshSantriList() {
    const container = document.getElementById('santri-list-container');
    const reportContainer = document.getElementById('report-santri-list');
    if (!container) return;

    const filtered = localCache.santri.filter(s => s.pembimbing === localCache.selectedPembimbing);
    container.innerHTML = '';
    if(reportContainer) reportContainer.innerHTML = '';

    filtered.forEach(s => {
        container.innerHTML += `
            <div class="flex justify-between p-4 border rounded-lg mb-2 bg-white shadow-sm">
                <div><h4 class="font-bold">${s.nama}</h4><p class="text-xs text-gray-500">${s.nis} | Wali: ${s.wali || '-'}</p></div>
                <button onclick="deleteData('santri', '${s.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
            </div>`;
        
        if(reportContainer) {
            reportContainer.innerHTML += `
                <div class="bg-white p-4 border rounded-xl shadow-sm">
                    <p class="font-bold text-gray-800 mb-2">${s.nama}</p>
                    <div class="flex flex-col gap-2">
                        <button onclick="generateWeeklyReport('${s.nis}')" class="text-xs bg-indigo-50 text-indigo-600 py-1 rounded">Pekanan</button>
                        <button onclick="generateMonthlyReport('${s.nis}')" class="text-xs bg-purple-50 text-purple-600 py-1 rounded">Bulanan</button>
                        <button onclick="generateRaporReport('${s.nis}')" class="text-xs bg-emerald-50 text-emerald-600 py-1 rounded">Rapor</button>
                    </div>
                </div>`;
        }
    });
}

function populateSantriSelects() {
    const selectIds = ['tahfidz-santri-select', 'tahsin-santri-select', 'murajaah-santri-select', 'hadits-santri-select', 'mutabaah-santri-select', 'absensi-santri-select'];
    const filtered = localCache.santri.filter(s => s.pembimbing === localCache.selectedPembimbing);
    selectIds.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = '<option value="">-- Pilih Santri --</option>';
        filtered.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id; opt.textContent = s.nama;
            opt.dataset.nis = s.nis; opt.dataset.nama = s.nama;
            el.appendChild(opt);
        });
    });
}

function populateSesiSelect() {
    const el = document.getElementById('absensi-sesi');
    if (!el) return;
    el.innerHTML = '<option value="">-- Pilih Sesi --</option>';
    localCache.sesi.forEach(s => {
        el.innerHTML += `<option value="${s.id}" data-nama="${s.nama}">${s.nama}</option>`;
    });
}

// 6. GENERATOR LAPORAN (CORE)
window.generateWeeklyReport = function(nis) {
    const santri = localCache.santri.find(s => s.nis === nis);
    const today = new Date();
    const weekAgo = new Date(today); weekAgo.setDate(today.getDate() - 7);
    
    // Filter data khusus santri ini dalam 1 minggu terakhir
    const harian = localCache.tahfidz.filter(t => t.santri_id === nis && t.tanggal >= weekAgo.toISOString().split('T')[0]);

    let html = `
        <div id="print-area" style="padding: 40px; font-family: 'Times New Roman'; border: 1px solid #ccc;">
            <center><h2>LAPORAN PEKANAN TAHFIDZ</h2><h3>MA'HAD ABU BAKAR ASH-SHIDDIQ</h3></center>
            <hr><br>
            <p>Nama: <b>${santri.nama}</b></p>
            <p>NIS: ${santri.nis}</p>
            <p>Pembimbing: ${santri.pembimbing}</p>
            <table border="1" width="100%" style="border-collapse: collapse; margin-top: 10px;">
                <tr bgcolor="#f2f2f2"><th>Tanggal</th><th>Juz</th><th>Halaman</th><th>Nilai</th></tr>
                ${harian.map(h => `<tr><td>${h.tanggal}</td><td>${h.juz}</td><td>${h.halaman}</td><td>${h.nilai}</td></tr>`).join('')}
            </table>
            <br><br>
            <table width="100%">
                <tr>
                    <td align="center">Orang Tua<br><br><br>( ${santri.wali || '...............'} )</td>
                    <td align="center">Pembimbing<br><br><br>( ${santri.pembimbing} )</td>
                </tr>
            </table>
        </div>`;
    
    document.getElementById('report-print-area').innerHTML = html;
    document.getElementById('weekly-report-detail').classList.remove('hidden');
    window.scrollTo(0, document.body.scrollHeight);
};

window.generateMonthlyReport = function(nis) { /* Logika mirip weekly tapi 30 hari */ 
    showToast("Fitur Laporan Bulanan Siap Cetak", "info");
    generateWeeklyReport(nis); // Sementara panggil weekly untuk demo struktur
};

window.generateRaporReport = function(nis) { /* Logika rapor semester */
    showToast("Fitur Rapor Semester Siap Cetak", "info");
    generateWeeklyReport(nis); 
};

window.downloadPDF = function() {
    const element = document.getElementById('print-area');
    const opt = { margin: 1, filename: 'Laporan_Tahfidz.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
    html2pdf().set(opt).from(element).save();
};

window.closeReport = function() {
    document.getElementById('weekly-report-detail').classList.add('hidden');
};

// 7. EVENT HANDLERS
document.getElementById('form-add-santri').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        nis: document.getElementById('santri-nis').value,
        nama: document.getElementById('santri-nama').value,
        kelas: document.getElementById('santri-kelas').value,
        wali: document.getElementById('santri-wali').value,
        pembimbing: localCache.selectedPembimbing, // OTOMATIS SINKRON
        created_at: new Date().toISOString()
    };
    await window.firestore.addDoc(window.firestore.collection(window.db, 'santri'), data);
    e.target.reset();
    showToast("Santri berhasil ditambahkan", "success");
});

// 8. UTILS & INIT
window.deleteData = async (coll, id) => {
    if(!confirm("Hapus data?")) return;
    await window.firestore.deleteDoc(window.firestore.doc(window.db, coll, id));
    showToast("Data dihapus", "success");
};

window.showToast = function(msg, type) {
    const t = document.createElement('div');
    t.className = `toast ${type}`; t.textContent = msg;
    document.body.appendChild(t); setTimeout(() => t.remove(), 3000);
};

function updateStats() {
    const el = document.getElementById('stat-santri');
    if(el) el.textContent = localCache.santri.length;
}

document.addEventListener('DOMContentLoaded', () => {
    if (localCache.selectedPembimbing) document.getElementById('pembimbing-sub-menu').classList.remove('hidden');
    const wait = setInterval(() => {
        if (window.db) { clearInterval(wait); initFirebaseListeners(); }
    }, 100);
});
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b7e1534f0875f60',t:'MTc2NzM5NzAzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
